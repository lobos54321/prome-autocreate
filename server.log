
> prome@0.0.0 start
> node server.js

[dotenv@17.2.1] injecting env (14) from .env -- tip: 📡 observe env with Radar: https://dotenvx.com/radar
🚀 Starting Prome Platform server
✅ Dify API environment variables are configured
Server is running on port 8080
🔍 Performing database health check...
✅ Database health check passed - all required tables exist
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T04:58:48.907Z'
}
📊 Context check: 71 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771b71acce6aadd-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 04:58:50 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=q%2FxnZQCF9Ekpee1k%2FrIZyU6pWD89WTr306vt4ITMxxD3ppuoWP1Wz54bOeNnwmVRAmE0S6VI38sR%2B6AU80WX1D%2BNbLpkaZlM3xWAf%2Bxxg48yZgEEAsi45Mun8dd665qWWC9xdGVs51rC"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3982&min_rtt=3975&rtt_var=1505&sent=5&recv=5&lost=0&retrans=0&sent_bytes=2827&recv_bytes=939&delivery_rate=1002727&cwnd=252&unsent_bytes=0&cid=f7d76f7440152572&ts=995&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1056
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1056 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002280 = 23 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 23 points. Balance: 6400 → 6377
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T04:58:57.213Z'
}
📊 Context check: 88 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771b74ea840e7c1-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 04:58:58 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=yreUiz4%2BllhbVRduDnSfiiZ%2B5yJ0nbwmLnZt6YwjOLaKTrheUYpFH7YJRowVhVGqDvkugbfC1E3EDc5s8iEQCsq%2B1Un%2FOZWqx3sFa6RpQr%2BQe8B5EwMIN7p3MktZTssyvzTfNjxtx8gb"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3855&min_rtt=3028&rtt_var=1726&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=445178&cwnd=250&unsent_bytes=0&cid=36e8f4e65a2c70c2&ts=617&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1087
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1087 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002342 = 24 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 24 points. Balance: 6348 → 6324
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T04:59:22.285Z'
}
📊 Context check: 105 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771b7eb1fcc1538-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 04:59:23 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=ILOKKAzr1uOIk3G7gEmuC%2FvTEMF2riZUlvLbQppgFwH22PvTFpKvZPIuFqPuHhNzDWhB5d08kypnqXCYzBY%2Bpwz1Ma6Nlt1EbCb41Z9gK2FIeOFhUnY06HfWRRwoePcxGZ91AMPDuY3I"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=5679&min_rtt=3570&rtt_var=2845&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=377591&cwnd=250&unsent_bytes=0&cid=7609e25ef32d8684&ts=635&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1118
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1118 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002404 = 25 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 25 points. Balance: 6324 → 6299
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:01:41.462Z'
}
📊 Context check: 122 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771bb512b36eff4-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:01:42 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=z%2F%2FSfY6FpVTklBnSdbrFn3UPXpbiha9HhxZ7C7%2B6M6PXDNweFgVRa7y5F4vIes8xdOO9fUXNYwcK7GpUAQ43Ut2%2FK7y3ufoZ0waY1c34pim966j4IIbJJiZtRijUk3m8GuhpuKF%2BHUyA"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=7419&min_rtt=3513&rtt_var=4003&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=383717&cwnd=250&unsent_bytes=0&cid=59cf7c527cf9a35e&ts=971&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1151
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1151 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002482 = 25 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 25 points. Balance: 6299 → 6274
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:01:49.283Z'
}
📊 Context check: 139 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771bb81ef275c0c-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:01:50 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=RGLQvdKMiEz9omthqEre7mfsogVDe9bXtFoOmYuqr6g%2BCdqDBNOZYhLe%2Fk3bkMj6I%2Be%2BDHFF2yIukP2U841oRnsmtyw3TtPwBiKswbASh2Qz9RxuAgu%2FLa6f1cF8aEdeBqeJjmKXWOtD"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4396&min_rtt=3943&rtt_var=2386&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=177977&cwnd=243&unsent_bytes=0&cid=95affa08734b8c86&ts=648&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1180
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1180 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002528 = 26 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 26 points. Balance: 6274 → 6248
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:10:28.631Z'
}
📊 Context check: 156 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771c8301b3b0fc3-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:10:30 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=xcWYrQZ%2BmTB5zjRSN317i3nDotiETajzVVHaIjqfI1s%2BM8Ax8Y3tQwXH2m0u8gT8dkn33lSg%2BRLgp53uJIVUn54azxuViJXU97D1im1OixaRKbQpBeu6wIM7o%2FmMxLW7KqomQFuzHb%2FO"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4085&min_rtt=4025&rtt_var=1630&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=299023&cwnd=245&unsent_bytes=0&cid=3fb68120b88f6fd3&ts=1036&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1211
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1211 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002590 = 26 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 26 points. Balance: 6248 → 6222
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "nihao",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: 'nihao...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:11:59.093Z'
}
📊 Context check: 172 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771ca654e6bd7ff-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:12:00 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=CXEXVIdnLXRtX8CrjcA4qgiEvvR0fLaUUgqa%2FdBNQl0FLYw7onJ%2Bjv3Ca%2Fib%2BoFST4vDhb4gRN1qUmz0HEv3lhyk%2BQWRyYKcPAJt3BIihAK3Y0l0Lb5kE38rovGiAVXDKccQHww%2F2dg9"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3920&min_rtt=3608&rtt_var=1576&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1209&delivery_rate=373614&cwnd=250&unsent_bytes=0&cid=68c78fc8228a9f8b&ts=707&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1243
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1243 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002654 = 27 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 27 points. Balance: 6222 → 6195
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你哈",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你哈...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:29:31.417Z'
}
📊 Context check: 189 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771e4186dc65c0d-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:29:33 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=VpnoZzw24396GPD9lhLdZ233iusy2%2Bd4wvXr45IuKID9dSqoOa84rAEgTVuJs6H%2FBTtks9Q1k8z3iPvqB1OhnI6yQmmtxbKPs7CLKL9LRD0zoAZCZvAY92BvbUQvDTNJovZIIMJA9Kzx"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=5206&min_rtt=4985&rtt_var=2311&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=199585&cwnd=250&unsent_bytes=0&cid=9281c3aa65077b6f&ts=1050&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1275
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1275 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002718 = 28 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 28 points. Balance: 6195 → 6167
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你哈",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你哈...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:29:39.940Z'
}
📊 Context check: 206 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771e44a8cfeaae1-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:29:40 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=W6IaczSw3iM5rBUqmrKLNcARAWtOxbtxhKroOE%2FukM7h3xpCKC%2FD7PvckaTmHGQZ3WL8WWGgJyLSLJ1zkVQBc1eqlua9migH9tRPfjXrr7pkEx0BzAw346SrwFwRJ12h52XzgZrosz6L"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4287&min_rtt=3954&rtt_var=2148&sent=5&recv=5&lost=0&retrans=0&sent_bytes=2827&recv_bytes=939&delivery_rate=611060&cwnd=252&unsent_bytes=0&cid=746e6c16a6c6234b&ts=626&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1307
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1307 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002782 = 28 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 28 points. Balance: 6133 → 6105
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:29:51.110Z'
}
📊 Context check: 223 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771e4904e6ee7de-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:29:52 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=KePRjcaeqFIB7B5kiV6uMwmhDbHW7bgfj%2FEJN3IYQMqCyIn0c4lfnB%2F32IayG%2B67NRKocLJiqxg6XX0WuU6pjTSiJBTbJi7e%2BAYaP7gJb5PMkv8dsMjMZwc%2FPrckapvdjhSnEU1zI0PZ"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=5519&min_rtt=3987&rtt_var=4560&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=82969&cwnd=250&unsent_bytes=0&cid=87557ae8697a1529&ts=688&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1338
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1338 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002844 = 29 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 29 points. Balance: 6105 → 6076
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你再干嘛",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你再干嘛...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:30:12.522Z'
}
📊 Context check: 243 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771e517092ae7c6-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:30:13 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=ZOHqZruPpEormlGv7XeNvM0RrkM9wt%2BmnMG8WcnO9GrwP7bUr1c81q5%2B0cF9UQ44KrL%2BpQ2rDNcooAUkwDQIcPk1UwEW1RJoIcJI4Jm0BqJvEsf7am%2F4mNTrMpaIYBw%2BT0w1uH%2Ff%2Bu4H"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=31161&min_rtt=4432&rtt_var=17898&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1216&delivery_rate=304151&cwnd=250&unsent_bytes=0&cid=1aa772409ce95aa0&ts=679&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1372
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1372 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002912 = 30 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 30 points. Balance: 6076 → 6046
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:38:58.918Z'
}
📊 Context check: 260 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f1f06ba95e4f-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:39:00 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=l4C7EFrd0cNVkKM1A6H7cA%2B7onyZ%2FG378ZMWCuQhAH20ljuRySqaEULd9rqw7DZG%2FD95OBVKwzpX9N12Ekl6jnZH57l1p7kIXhmAoVujIZmSS4tSTLr3%2FYtPe23FgZCrwqlnLdXwelwy"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4329&min_rtt=3945&rtt_var=2249&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=191940&cwnd=247&unsent_bytes=0&cid=6ba3ba47d096e83b&ts=1044&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1403
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1403 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.002974 = 30 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 30 points. Balance: 6046 → 6016
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:39:09.336Z'
}
📊 Context check: 277 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f2317a37e7d0-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:39:10 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=%2BIs7voqfQ0P0WOna4b6b%2Ba8Sun%2FPAVmmyslKDWmZlLDuwlzka%2Fsg15HVWk1BoETJZp2j1bb%2Bz1fZcyRntofNmJxXB9C7avYqDoq9PnaZvMAOa0goYK0nli6uRodvpPO507arazZGcMXP"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4835&min_rtt=3614&rtt_var=2227&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=372993&cwnd=247&unsent_bytes=0&cid=37c2d0b1292a203f&ts=637&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1434
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1434 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003036 = 31 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 31 points. Balance: 6016 → 5985
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:41:22.982Z'
}
📊 Context check: 294 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f574d850a97f-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:41:24 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=WrMmKEeR%2Blse1MSdTuJQtSjm3CI%2BZ3yuZOFa6wPtX5R3i6jDXI25DuIpGG6AEb0CQzd5BdMQjr6nirUK1TpoUlnyMYq%2F6xpvulv8k0iCQHIrLizRp1NkZaxeDL%2FIju7sUH11jg7E3tZA"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=5652&min_rtt=3964&rtt_var=4863&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=77147&cwnd=250&unsent_bytes=0&cid=899e2c593d31e34d&ts=972&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1465
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1465 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003098 = 31 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 31 points. Balance: 5985 → 5954
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:41:33.940Z'
}
📊 Context check: 311 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f5b91a615c0d-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:41:34 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=3yAshOzxNg4DZMX6vGnJLGZOhyiv0aco2KhytvLbA5zVpGgNQmaxKmkHEaGpdEcaXvr4yANtX8N%2BFzE1EDEafSy6ioeYpG1e49QX1sEps10qf1uEzQPssI8X1II8AVeocXjvI8Ti5MAC"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=4086&min_rtt=3952&rtt_var=1751&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=267938&cwnd=250&unsent_bytes=0&cid=fa1f63bc275bb6bb&ts=723&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1496
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1496 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003160 = 32 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 32 points. Balance: 5954 → 5922
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:42:29.503Z'
}
📊 Context check: 328 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f7145eac1874-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:42:30 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=e8neLsCSEmEBfJ98L8w%2F3Zk7QRcFHxv7X%2BLFLGqJO8xwwU1rYkuOCp7U2Q53j0W2e%2FsCPhd5hfSlm%2B%2B2n316K227cO6GZv7eyKyCi1diGlBzNs6b5Hfsb%2BhB2o%2BePXSkND%2BrZLE5WxCQ"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3889&min_rtt=3245&rtt_var=1677&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=415408&cwnd=250&unsent_bytes=0&cid=6d52c1614f91e6d5&ts=989&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1527
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1527 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003222 = 33 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 33 points. Balance: 5922 → 5889
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:42:37.651Z'
}
📊 Context check: 345 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f748e8065bf6-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:42:38 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=tInqWkBNyxWXj6%2Bo7wZvzqUg7vMcJlNn13VP2b%2Bz56kPYlD2LkUfvaPOzQM7JtEtJjio8mRf15SsCLSH08vW%2FbUCnVAMFchUBwjP8C7iCx6VNd70NOzEhDI2gYHztHMtO2Nn6y0frTH%2B"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3906&min_rtt=3815&rtt_var=1496&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=353342&cwnd=250&unsent_bytes=0&cid=56f8596d070d1e67&ts=637&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1558
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1558 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003284 = 33 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 33 points. Balance: 5889 → 5856
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:43:50.988Z'
}
📊 Context check: 362 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f911ae30e7e5-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:43:52 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=YumR7Gw%2FGJ%2FjUK4BQujpOI4D%2BT05iU9SNOnFPjmEZ5S3bMOh1%2FEtwjHE8ZL%2FTxKpV7mq4D4O8FNxLykGvVz6ZF0bYXmf%2FC6yM1eELs91Z0woRlhFhk%2BLZ6mrkk4DvESNtWqMwkFxhED8"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=10304&min_rtt=5257&rtt_var=5521&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=256420&cwnd=250&unsent_bytes=0&cid=fe611738d7842a88&ts=973&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1589
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1589 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003346 = 34 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 34 points. Balance: 5848 → 5814
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "你好",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: '你好...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:44:01.128Z'
}
📊 Context check: 379 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9771f9513de87764-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:44:02 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=E2Ac0f6e%2F5FOJukkrKTL3xhJX%2FnGQi1crqgQvu%2FtsH0tcqp4l9SZGJummw5Yx%2BR2VBQ5yUohLCfwkLcUHJpYlDhOUxvouHCWy0xAXJWrdf5FEr1ADvN2X48y%2F%2FFnwjor9dDWBs7cK9LN"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3093&min_rtt=3002&rtt_var=1308&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1210&delivery_rate=361200&cwnd=250&unsent_bytes=0&cid=766bd772764fa65c&ts=631&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1620
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1620 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003408 = 35 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 35 points. Balance: 5814 → 5779
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "nih",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "b0e0e191-2b35-4c5d-b934-4649d367c4d1",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔍 Looking up conversation in database: b0e0e191-2b35-4c5d-b934-4649d367c4d1
✅ Found existing DIFY conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
🔄 Continuing existing conversation: b0e0e191-2b35-4c5d-b934-4649d367c4d1
📤 [DIFY API] Sending request to chat-messages: {
  query: 'nih...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  timestamp: '2025-08-30T05:56:58.575Z'
}
📊 Context check: 394 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '97720c4ceed55c06-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Sat, 30 Aug 2025 05:56:59 GMT',
  nel: '{"success_fraction":0,"report_to":"cf-nel","max_age":604800}',
  'report-to': '{"endpoints":[{"url":"https:\\/\\/a.nel.cloudflare.com\\/report\\/v4?s=c9f3V8r%2BIubvuGPihjEC%2BajrBZCgIjlLiimmYV138c0T64IL2DF01vGVSiem0YodP63T2Pb62JBimMb6JnwSAvsIMiyD4T7Lde87KrzC%2BlkNw8iBYP0KKENMkXveYQkisUUj02RiP%2BVH"}],"group":"cf-nel","max_age":604800}',
  server: 'cloudflare',
  'server-timing': 'cfL4;desc="?proto=TCP&rtt=3863&min_rtt=3079&rtt_var=1714&sent=3&recv=5&lost=0&retrans=0&sent_bytes=234&recv_bytes=1207&delivery_rate=437804&cwnd=251&unsent_bytes=0&cid=c6c25825d4eab511&ts=960&x=0"',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.7.2'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'parallel_branch_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: false
}
[Server] 📊 从响应体提取usage信息 (含价格): token统计和价格数据已获取
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 1651
}
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 1651 tokens
💰 [COST-WORKFLOW_STREAM] Actual cost: $0.003470 = 35 points
✅ [BILLING-WORKFLOW_STREAM] Deducted 35 points. Balance: 5779 → 5744
🔍 ensureConversationExists called with: {
  conversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  difyConversationId: 'b0e0e191-2b35-4c5d-b934-4649d367c4d1',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
