<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>N8n异步测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            background-color: #F3F4F6;
            border: 1px solid #D1D5DB;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }
        button {
            background-color: #8B5CF6;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
        }
        button:hover {
            background-color: #7C3AED;
        }
        button:disabled {
            background-color: #9CA3AF;
            cursor: not-allowed;
        }
        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 4px;
            border: 1px solid #ddd;
        }
        .success {
            background-color: #D1FAE5;
            color: #065F46;
            border-color: #A7F3D0;
        }
        .error {
            background-color: #FEE2E2;
            color: #991B1B;
            border-color: #FECACA;
        }
        .processing {
            background-color: #DBEAFE;
            color: #1E3A8A;
            border-color: #93C5FD;
        }
        .debug-info {
            background-color: #1F2937;
            color: #F9FAFB;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .video-link {
            display: inline-block;
            background-color: #059669;
            color: white;
            padding: 10px 20px;
            text-decoration: none;
            border-radius: 6px;
            margin: 5px;
        }
        .video-link:hover {
            background-color: #047857;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔍 N8n异步工作流调试</h1>
        <p>这个页面用于测试N8n AI Agent异步响应和视频地址获取</p>
        
        <div class="test-section">
            <h3>📋 测试步骤</h3>
            <button onclick="testInitialRequest()">1️⃣ 发送初始请求</button>
            <button onclick="testTaskQuery()" id="queryBtn" disabled>2️⃣ 查询任务结果</button>
            <button onclick="testDirectMessage()">3️⃣ 发送直接消息</button>
            <button onclick="clearResults()">🧹 清除结果</button>
        </div>

        <div id="currentTaskId" style="display: none;"></div>
        <div id="results"></div>
    </div>

    <script>
        const WEBHOOK_URL = 'https://n8n-worker-k4m9.zeabur.app/webhook/9d5986f5-fcba-42bf-b3d7-5fd94660943a/chat';
        let currentTaskId = null;
        let sessionId = localStorage.getItem('n8n_session_id') || `test_session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
        localStorage.setItem('n8n_session_id', sessionId);

        function addResult(type, title, content) {
            const resultsDiv = document.getElementById('results');
            const resultDiv = document.createElement('div');
            resultDiv.className = `result ${type}`;
            resultDiv.innerHTML = `
                <h4>${title}</h4>
                <div>${content}</div>
            `;
            resultsDiv.appendChild(resultDiv);
            resultsDiv.scrollTop = resultsDiv.scrollHeight;
        }

        function addDebugInfo(title, data) {
            const debugDiv = document.createElement('div');
            debugDiv.innerHTML = `<strong>${title}:</strong>`;
            const codeDiv = document.createElement('div');
            codeDiv.className = 'debug-info';
            codeDiv.textContent = typeof data === 'string' ? data : JSON.stringify(data, null, 2);
            debugDiv.appendChild(codeDiv);
            document.getElementById('results').appendChild(debugDiv);
        }

        async function testInitialRequest() {
            console.log('🚀 测试1: 发送初始视频创建请求');
            
            const messageContent = `视频创作需求：
🎬 视频时长：24秒
📝 产品描述：今天我们艺站lobos老师带我们在公园上了一节户外写生课，阳光特别好，大家都很兴奋。老师让我们画身边的植物，我第一次发现原来光影变化这么有趣。
🖼️ 产品图片：https://youke1.picui.cn/s1/2025/09/18/68cb9660072c4.jpg
👤 人物性别：female

请根据以上信息创建视频内容。`;

            const payload = {
                action: "sendMessage",
                sessionId: sessionId,
                chatInput: messageContent
            };

            try {
                addResult('processing', '📤 发送初始请求', '正在发送视频创建请求...');
                
                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload)
                });

                addDebugInfo('发送载荷', payload);
                addDebugInfo('HTTP状态', `${response.status} ${response.statusText}`);

                if (response.ok) {
                    const responseData = await response.text();
                    addDebugInfo('原始响应', responseData);

                    try {
                        const parsedResponse = JSON.parse(responseData);
                        addDebugInfo('解析响应', parsedResponse);

                        if (parsedResponse.code === 200 && parsedResponse.data && parsedResponse.data.taskId) {
                            currentTaskId = parsedResponse.data.taskId;
                            document.getElementById('currentTaskId').textContent = currentTaskId;
                            document.getElementById('currentTaskId').style.display = 'block';
                            document.getElementById('queryBtn').disabled = false;
                            
                            addResult('success', '✅ 收到任务ID', 
                                `TaskID: ${currentTaskId}<br>` +
                                `这表明AI Agent已开始处理，现在可以查询任务结果`
                            );
                        } else if (parsedResponse.videoUrl) {
                            addResult('success', '🎉 直接收到视频地址!', 
                                `<a href="${parsedResponse.videoUrl}" target="_blank" class="video-link">📹 下载视频</a><br>` +
                                `URL: ${parsedResponse.videoUrl}`
                            );
                        } else {
                            addResult('processing', '⏳ 收到其他响应', 
                                `响应内容: ${responseData}<br>` +
                                `需要进一步分析响应格式`
                            );
                        }
                    } catch (e) {
                        addResult('error', '❌ JSON解析失败', 
                            `响应不是JSON格式: ${responseData}`
                        );
                    }
                } else {
                    const errorText = await response.text();
                    addResult('error', '❌ HTTP错误', 
                        `状态: ${response.status}<br>内容: ${errorText}`
                    );
                }
            } catch (error) {
                addResult('error', '❌ 请求失败', error.message);
                console.error('请求失败:', error);
            }
        }

        async function testTaskQuery() {
            if (!currentTaskId) {
                addResult('error', '❌ 没有TaskID', '请先发送初始请求获取TaskID');
                return;
            }

            console.log('🔍 测试2: 查询任务结果');

            const queryPayload = {
                action: "sendMessage",
                sessionId: sessionId,
                chatInput: `查询任务${currentTaskId}的执行结果`
            };

            try {
                addResult('processing', '🔍 查询任务结果', `正在查询TaskID: ${currentTaskId}`);

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(queryPayload)
                });

                addDebugInfo('查询载荷', queryPayload);

                if (response.ok) {
                    const responseData = await response.text();
                    addDebugInfo('查询响应', responseData);

                    // 检查是否包含视频URL
                    let videoUrl = null;
                    try {
                        const parsedResponse = JSON.parse(responseData);
                        // 优先检查你的自定义字段名
                        videoUrl = parsedResponse.finalvideoURL || 
                                  parsedResponse.finalVideoURL ||
                                  parsedResponse.finalVideoUrl ||
                                  parsedResponse.videoUrl || parsedResponse.video_url || 
                                  parsedResponse.downloadUrl || parsedResponse.download_url ||
                                  parsedResponse.url || parsedResponse.link ||
                                  parsedResponse.result || parsedResponse.output ||
                                  parsedResponse.file_url || parsedResponse.fileUrl ||
                                  parsedResponse.videoLink || parsedResponse.video_link;
                        
                        console.log('🔍 检查字段: finalvideoURL =', parsedResponse.finalvideoURL);
                        console.log('🔍 检查字段: finalVideoURL =', parsedResponse.finalVideoURL);

                        if (parsedResponse.finalVideoUrl && typeof parsedResponse.finalVideoUrl === 'string') {
                            const match = parsedResponse.finalVideoUrl.match(/视频地址[：:]\s*(https?:\/\/[^\s]+)/);
                            if (match) {
                                videoUrl = match[1];
                            }
                        }
                    } catch (e) {
                        // 检查文本响应
                        const urlMatch = responseData.match(/https?:\/\/[^\s]+\.(mp4|mov|avi)/gi);
                        if (urlMatch) {
                            videoUrl = urlMatch[0];
                        }
                    }

                    if (videoUrl) {
                        addResult('success', '🎉 找到视频地址!', 
                            `<a href="${videoUrl}" target="_blank" class="video-link">📹 下载视频</a><br>` +
                            `<a href="${videoUrl}" target="_blank" class="video-link">🎬 在线预览</a><br>` +
                            `URL: ${videoUrl}`
                        );
                    } else {
                        addResult('processing', '⏳ 任务仍在处理中', 
                            `响应: ${responseData}<br>` +
                            `可能需要等待更长时间或多次查询`
                        );
                    }
                } else {
                    const errorText = await response.text();
                    addResult('error', '❌ 查询失败', 
                        `状态: ${response.status}<br>内容: ${errorText}`
                    );
                }
            } catch (error) {
                addResult('error', '❌ 查询请求失败', error.message);
                console.error('查询失败:', error);
            }
        }

        async function testDirectMessage() {
            console.log('💬 测试3: 发送直接消息');

            const directPayload = {
                action: "sendMessage",
                sessionId: sessionId,
                chatInput: "请提供最新的视频生成结果"
            };

            try {
                addResult('processing', '💬 发送直接查询', '询问最新的视频结果...');

                const response = await fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(directPayload)
                });

                addDebugInfo('直接查询载荷', directPayload);

                if (response.ok) {
                    const responseData = await response.text();
                    addDebugInfo('直接查询响应', responseData);

                    // 检查响应中的视频URL
                    let videoUrl = null;
                    try {
                        const parsedResponse = JSON.parse(responseData);
                        // 优先检查你的自定义字段名
                        videoUrl = parsedResponse.finalvideoURL || 
                                  parsedResponse.finalVideoURL ||
                                  parsedResponse.finalVideoUrl ||
                                  parsedResponse.videoUrl || parsedResponse.video_url || 
                                  parsedResponse.downloadUrl || parsedResponse.url;
                        
                        console.log('🔍 直接查询检查字段: finalvideoURL =', parsedResponse.finalvideoURL);
                    } catch (e) {
                        const urlMatch = responseData.match(/https?:\/\/[^\s]+\.(mp4|mov|avi)/gi);
                        if (urlMatch) {
                            videoUrl = urlMatch[0];
                        }
                    }

                    if (videoUrl) {
                        addResult('success', '🎉 通过直接查询找到视频!', 
                            `<a href="${videoUrl}" target="_blank" class="video-link">📹 下载视频</a><br>` +
                            `URL: ${videoUrl}`
                        );
                    } else {
                        addResult('processing', '📝 收到文本响应', responseData);
                    }
                } else {
                    const errorText = await response.text();
                    addResult('error', '❌ 直接查询失败', errorText);
                }
            } catch (error) {
                addResult('error', '❌ 直接查询请求失败', error.message);
            }
        }

        function clearResults() {
            document.getElementById('results').innerHTML = '';
            currentTaskId = null;
            document.getElementById('currentTaskId').style.display = 'none';
            document.getElementById('queryBtn').disabled = true;
        }

        // 页面加载时显示当前配置
        window.onload = function() {
            addResult('success', '🔧 测试配置', 
                `Webhook: ${WEBHOOK_URL}<br>` +
                `SessionID: ${sessionId}<br>` +
                `准备测试N8n异步工作流`
            );
        };
    </script>
</body>
</html>