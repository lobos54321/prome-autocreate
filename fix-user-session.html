<!DOCTYPE html>
<html>
<head>
  <title>ä¿®å¤ç”¨æˆ·ä¼šè¯</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
    .section { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; }
    button { padding: 10px 20px; margin: 10px 5px; font-size: 16px; cursor: pointer; }
    .danger { background: #ff4444; color: white; border: none; }
    .success { background: #44ff44; color: black; border: none; }
    pre { background: #f0f0f0; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>ğŸ”§ ä¿®å¤ç”¨æˆ·ä¼šè¯å·¥å…·</h1>
  
  <div class="section">
    <h2>é—®é¢˜è¯Šæ–­</h2>
    <div id="diagnosis"></div>
  </div>
  
  <div class="section">
    <h2>ä¿®å¤æ“ä½œ</h2>
    <button class="danger" onclick="clearAll()">æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡æ–°ç™»å½•</button>
    <button class="success" onclick="checkStatus()">æ£€æŸ¥å½“å‰çŠ¶æ€</button>
  </div>
  
  <div class="section">
    <h2>æ“ä½œç»“æœ</h2>
    <div id="result"></div>
  </div>

  <script>
    function checkStatus() {
      const currentUser = localStorage.getItem('currentUser');
      const difyUserId = localStorage.getItem('dify_user_id');
      
      let diagnosis = '<h3>å½“å‰çŠ¶æ€ï¼š</h3>';
      
      if (currentUser) {
        try {
          const user = JSON.parse(currentUser);
          diagnosis += `<p><strong>ç”¨æˆ·ID:</strong> ${user.id}</p>`;
          diagnosis += `<p><strong>Email:</strong> ${user.email}</p>`;
          diagnosis += `<p><strong>ä½™é¢:</strong> ${user.balance} ç§¯åˆ†</p>`;
          
          // æ£€æŸ¥UUIDæ ¼å¼
          const isValidUUID = /^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i.test(user.id);
          
          if (!isValidUUID) {
            diagnosis += '<p style="color: red;"><strong>âŒ é—®é¢˜ï¼šç”¨æˆ·IDä¸æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼ï¼</strong></p>';
            diagnosis += '<p>è¿™ä¼šå¯¼è‡´æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼Œç§¯åˆ†æ— æ³•æ‰£é™¤ã€‚</p>';
            diagnosis += '<p><strong>å»ºè®®ï¼šç‚¹å‡»"æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡æ–°ç™»å½•"</strong></p>';
          } else {
            diagnosis += '<p style="color: green;"><strong>âœ… ç”¨æˆ·IDæ ¼å¼æ­£ç¡®</strong></p>';
          }
        } catch (e) {
          diagnosis += '<p style="color: red;">è§£æç”¨æˆ·æ•°æ®å¤±è´¥</p>';
        }
      } else {
        diagnosis += '<p style="color: red;">æœªæ‰¾åˆ°ç”¨æˆ·æ•°æ®</p>';
      }
      
      diagnosis += `<p><strong>Dify User ID:</strong> ${difyUserId || 'æœªè®¾ç½®'}</p>`;
      
      document.getElementById('diagnosis').innerHTML = diagnosis;
    }
    
    function clearAll() {
      if (!confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰ç¼“å­˜å¹¶é‡æ–°ç™»å½•å—ï¼Ÿè¿™ä¼šæ¸…é™¤æœ¬åœ°å¯¹è¯å†å²ã€‚')) {
        return;
      }
      
      // æ¸…é™¤æ‰€æœ‰localStorage
      localStorage.clear();
      
      // æ¸…é™¤æ‰€æœ‰sessionStorage
      sessionStorage.clear();
      
      // æ¸…é™¤æ‰€æœ‰cookies
      document.cookie.split(";").forEach(function(c) { 
        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
      });
      
      document.getElementById('result').innerHTML = `
        <p style="color: green; font-size: 18px;"><strong>âœ… å·²æ¸…é™¤æ‰€æœ‰ç¼“å­˜</strong></p>
        <p>æ­£åœ¨è·³è½¬åˆ°ç™»å½•é¡µé¢...</p>
      `;
      
      // è·³è½¬åˆ°ç™»å½•é¡µé¢
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
    }
    
    // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥
    window.onload = checkStatus;
  </script>
</body>
</html>
