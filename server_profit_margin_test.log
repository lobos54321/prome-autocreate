[dotenv@17.2.1] injecting env (19) from .env -- tip: 📡 version env with Radar: https://dotenvx.com/radar
🚀 Starting Prome Platform server
✅ Dify API environment variables are configured
Server is running on port 8080
🔍 Performing database health check...
✅ Database health check passed - all required tables exist
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🆕 前端要求新对话 - 生成全新conversation ID: f3b04251-2d1e-4634-b3d1-9b919cf96764，不查找数据库
🆕 Starting new conversation - letting DIFY initialize conversation variables
📤 [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:22:56.256Z'
}
📊 New conversation, no context management needed
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880bc264d6baaf9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:22:58 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=BgFYp5pfkPTQy95TtRqAjzKwOvd84gW1p22ggXZm9oRSOK4W1wwd2j8gMTwWqrSYv6SDX1jwcLgZ0ylWtDe8OoAULa6Gw1kBEVLKJ8Ii4nay3RbIWXg%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +261 tokens, $0.000654 (累计: 261 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +467 tokens, $0.00097 (累计: 728 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] ✅ message_end的usage为0，使用从node_finished累加的数据: 728 tokens
⚠️ Failed to parse streaming data: TypeError: Assignment to constant variable.
    at file:///Users/boliu/prome-autocreate/server.js:1751:28
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
✅ [BILLING-FIX] 用从node_finished累加的usage覆盖finalData: 728 tokens, $0.001624
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 728,
  billingSource: 'NORMAL'
}
🎯 [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759371782122-pfp4q
🔍 [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
✅ [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
💰 [BILLING-WORKFLOW_STREAM] Multi-node LLM: 728 tokens
💰 [COST-WORKFLOW_STREAM] Dify成本: $0.001624 → +25%利润 → ×10000汇率 = 21 积分
✅ [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5294 → 5273
✅ [BILLING-TRACKER] Success #1: WORKFLOW_STREAM-1759371782122-pfp4q
🔥 [STREAM] Sending balance update to frontend: 5273
🔍 ensureConversationExists called with: {
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  difyConversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
✅ Created new conversation record
✅ Messages saved successfully
✅ Saved streaming conversation to database
