[dotenv@17.2.1] injecting env (19) from .env -- tip: ğŸ“¡ version env with Radar: https://dotenvx.com/radar
ğŸš€ Starting Prome Platform server
âœ… Dify API environment variables are configured
Server is running on port 8080
ğŸ” Performing database health check...
âœ… Database health check passed - all required tables exist
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: f3b04251-2d1e-4634-b3d1-9b919cf96764ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:22:56.256Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880bc264d6baaf9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:22:58 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=BgFYp5pfkPTQy95TtRqAjzKwOvd84gW1p22ggXZm9oRSOK4W1wwd2j8gMTwWqrSYv6SDX1jwcLgZ0ylWtDe8OoAULa6Gw1kBEVLKJ8Ii4nay3RbIWXg%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +261 tokens, $0.000654 (ç´¯è®¡: 261 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +467 tokens, $0.00097 (ç´¯è®¡: 728 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 728 tokens
âš ï¸ Failed to parse streaming data: TypeError: Assignment to constant variable.
    at file:///Users/boliu/prome-autocreate/server.js:1751:28
    at process.processTicksAndRejections (node:internal/process/task_queues:105:5)
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 728 tokens, $0.001624
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 728,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759371782122-pfp4q
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 728 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001624 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5294 â†’ 5273
âœ… [BILLING-TRACKER] Success #1: WORKFLOW_STREAM-1759371782122-pfp4q
ğŸ”¥ [STREAM] Sending balance update to frontend: 5273
ğŸ” ensureConversationExists called with: {
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  difyConversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
