[dotenv@17.2.1] injecting env (19) from .env -- tip: âš™ï¸  override existing env vars with { override: true }
ğŸš€ Starting Prome Platform server
âœ… Dify API environment variables are configured
Server is running on port 8080
ğŸ” Performing database health check...
âœ… Database health check passed - all required tables exist
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: b2a54b94-36cb-401c-b470-0ce12a606d3fï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:09:16.404Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880a8272836d5d4-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:09:19 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=AAg1s9THP1810yG0tIKmHdb7%2FgrCRss0u%2Fug7jGvTj6UD1f7Cu3ZbfA7IqEICjhScz%2BYU7hGAMbay4AXlAe%2F4sibjXwhHdBZaS%2FJ9jPUaXsocR6npWI%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +262 tokens, $0.000662 (ç´¯è®¡: 262 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +463 tokens, $0.000932 (ç´¯è®¡: 725 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 725 tokens
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 725 tokens, $0.001594
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 725,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759370962578-etjzo
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 725 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Actual cost: $0.001594 = 16 points
âœ… [BILLING-WORKFLOW_STREAM] Deducted 16 points. Balance: 5327 â†’ 5311
âœ… [BILLING-TRACKER] Success #1: WORKFLOW_STREAM-1759370962578-etjzo
ğŸ”¥ [STREAM] Sending balance update to frontend: 5311
ğŸ” ensureConversationExists called with: {
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  difyConversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "4f6e64f6-d55e-4140-b016-a3fce6af11e8",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 4f6e64f6-d55e-4140-b016-a3fce6af11e8
ğŸ” Looking up conversation in database: 4f6e64f6-d55e-4140-b016-a3fce6af11e8
âœ… Found existing DIFY conversation: 4f6e64f6-d55e-4140-b016-a3fce6af11e8
ğŸ”„ Continuing existing conversation: 4f6e64f6-d55e-4140-b016-a3fce6af11e8
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  timestamp: '2025-10-02T02:11:38.984Z'
}
ğŸ“Š Context check: 16 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880ab9cacf6d5e0-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:11:40 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=OSeW1gFlZO05abTxiV3Di6qlcEuNogm1K96%2F3RutB6KQXFsjrYA%2FYlhjO4qWoj4QBoboXqfxdAAu50eLz5oFHA%2Bsq%2B3wGzFL4EpnQna2PHyWDZG%2BAW4%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +292 tokens, $0.00071 (ç´¯è®¡: 292 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +461 tokens, $0.000928 (ç´¯è®¡: 753 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 753 tokens
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 753 tokens, $0.0016380000000000001
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 753,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #2: WORKFLOW_STREAM-1759371103653-o439a
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 753 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Actual cost: $0.001638 = 17 points
âœ… [BILLING-WORKFLOW_STREAM] Deducted 17 points. Balance: 5311 â†’ 5294
âœ… [BILLING-TRACKER] Success #2: WORKFLOW_STREAM-1759371103653-o439a
ğŸ”¥ [STREAM] Sending balance update to frontend: 5294
ğŸ” ensureConversationExists called with: {
  conversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  difyConversationId: '4f6e64f6-d55e-4140-b016-a3fce6af11e8',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
