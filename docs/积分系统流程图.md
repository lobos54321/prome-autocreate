# 积分系统完整流程图

## 1️⃣ 用户登录 - 余额获取流程

```
用户登录
    ↓
src/lib/auth.ts: login()
    ↓
src/lib/supabase.ts: signIn()
    ↓
调用 Supabase Auth API 验证密码
    ↓
查询 users 表获取用户信息
    ↓
SELECT id, email, name, role, balance FROM users WHERE id = '用户UUID'
    ↓
返回用户对象: { id, email, name, role, balance: 5352 }
    ↓
auth.ts 保存到内存: this.currentUser = user
    ↓
保存到 localStorage: 
    localStorage.setItem('currentUser', JSON.stringify({
        id: '9dee4891-89a6-44ee-8fe8-69097846e97d',
        email: 'lobos54321@gmail.com',
        balance: 5352  // ← 这里是数据库的真实余额
    }))
    ↓
触发事件: window.dispatchEvent('auth-state-changed')
    ↓
Navbar 和 PointsDisplay 组件监听到事件
    ↓
显示余额: 5352 积分
```

---

## 2️⃣ 发送消息 - 积分扣除流程

```
用户在聊天界面输入消息并发送
    ↓
src/components/chat/DifyChatInterface.tsx: sendMessage()
    │
    ├─ 获取用户ID: 
    │   const userId = user?.id || localStorage.getItem('dify_user_id')
    │   // 应该是: '9dee4891-89a6-44ee-8fe8-69097846e97d'
    │   // 但你的是: 'admin-user-123' ← 问题所在！
    │
    ├─ 准备请求数据:
    │   { message: '用户消息', userId: userId, conversationId: xxx }
    │
    └─ 发送 HTTP 请求:
        ↓
    POST /api/dify/chat-messages (流式模式)
    或
    POST /api/dify/workflows/run (工作流模式)
        ↓
    ═══════════════════════════════════════
    【后端处理 - server.js】
    ═══════════════════════════════════════
        ↓
    第1步: 接收请求 (server.js:1400+)
        const { message, userId, conversationId } = req.body
        console.log('收到用户请求:', userId)
        // userId = 'admin-user-123' ← 错误的ID传到后端！
        ↓
    第2步: 调用 Dify API
        fetch('https://api.dify.ai/v1/chat-messages', {
            method: 'POST',
            body: JSON.stringify({
                query: message,
                user: userId,  // ← 传给Dify
                conversation_id: conversationId
            })
        })
        ↓
    第3步: 接收 Dify 响应 (流式)
        data: {"event": "message", "answer": "回答内容..."}
        data: {"event": "message_end", "metadata": {
            "usage": {
                "total_tokens": 4163,        ← Token数量
                "prompt_tokens": 3500,
                "completion_tokens": 663,
                "total_price": 0.00905475   ← 实际成本
            }
        }}
        ↓
    第4步: 调用积分扣除函数 (server.js:1848)
        const billingInfo = await handleTokenBilling(
            finalData,           // Dify响应数据
            userId,              // 'admin-user-123' ← 错误ID！
            'WORKFLOW_STREAM'
        )
        ↓
    ═══════════════════════════════════════
    【积分计算与扣除 - server.js:673-920】
    ═══════════════════════════════════════
        ↓
    handleTokenBilling() 函数执行:
        ↓
    5-1: 提取 Token 数据
        const totalTokens = responseData.metadata.usage.total_tokens  // 4163
        const actualCost = responseData.metadata.usage.total_price    // 0.00905475
        ↓
    5-2: 计算扣除积分
        const pointsToDeduct = Math.ceil(actualCost * 10000)
        // 0.00905475 * 10000 = 90.5475 → 91 积分
        console.log('💰 需要扣除 91 积分')
        ↓
    5-3: 获取有效用户ID (server.js:734)
        const userId = getValidUserId(user)
        // getValidUserId('admin-user-123')
        // → 检查是否是UUID: ❌ 不是！
        // → 返回: 'admin-user-123' (不转换)
        ↓
    5-4: 查询数据库中的用户 (server.js:743-747)
        const { data: userBalance, error } = await supabase
            .from('users')
            .select('balance')
            .eq('id', 'admin-user-123')  ← 错误的ID！
            .single()
        ↓
    5-5: 数据库查询失败！(server.js:749-792)
        ❌ balanceError: "invalid input syntax for type uuid"
        
        console.log('⚠️ User not found in database: admin-user-123')
        console.log('💡 Creating guest user session')
        console.log('⚠️ Guest user - no points deducted')
        
        // 在内存中记录游客余额（不保存到数据库）
        global.guestBalances.set('admin-user-123', 10000 - 91)
        
        return {
            tokens: 4163,
            points: 91,
            newBalance: 9909,  // 内存中的假余额
            success: true,
            isGuest: true      // ← 标记为游客！
        }
        ↓
    【如果用户ID正确，应该执行这个分支】
    5-6: 正常扣除积分 (server.js:793-850)
        const currentBalance = userBalance.balance  // 5352
        const newBalance = currentBalance - 91      // 5261
        
        // 更新数据库
        UPDATE users SET balance = 5261 WHERE id = '9dee4891-...'
        
        console.log('✅ Deducted 91 points. Balance: 5352 → 5261')
        
        return {
            tokens: 4163,
            points: 91,
            newBalance: 5261,
            success: true,
            isGuest: false
        }
        ↓
    ═══════════════════════════════════════
    【返回前端】
    ═══════════════════════════════════════
        ↓
    第6步: 发送余额更新事件给前端 (server.js:1886-1898)
        res.write(`data: ${JSON.stringify({
            event: 'balance_updated',
            data: {
                newBalance: billingInfo.newBalance,  // 9909 (游客) 或 5261 (真实)
                pointsDeducted: billingInfo.points,  // 91
                tokens: billingInfo.tokens           // 4163
            }
        })}\n\n`)
        ↓
    ═══════════════════════════════════════
    【前端接收更新】
    ═══════════════════════════════════════
        ↓
    DifyChatInterface.tsx:1857 监听 SSE 事件
        if (parsed.event === 'balance_updated') {
            console.log('收到余额更新:', parsed.data.newBalance)
            
            // 更新 authService
            const currentUser = authService.getCurrentUserSync()
            currentUser.balance = parsed.data.newBalance
            
            // 更新 localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser))
            
            // 触发全局事件
            window.dispatchEvent(new CustomEvent('balance-updated', {
                detail: { balance: parsed.data.newBalance }
            }))
        }
        ↓
    PointsDisplay.tsx:57 监听 'balance-updated' 事件
        setUser(prev => ({ ...prev, balance: newBalance }))
        
        // 显示 Toast 通知
        toast.success(`✅ 消费 ${tokens} tokens (${points} 积分)`)
        ↓
    界面更新: 显示新余额
```

---

## 3️⃣ 数据存储位置

### 📁 数据库 (Supabase)
```sql
-- users 表
CREATE TABLE users (
    id UUID PRIMARY KEY,           -- 9dee4891-89a6-44ee-8fe8-69097846e97d
    email TEXT,                    -- lobos54321@gmail.com
    name TEXT,                     -- Admin User
    balance INTEGER DEFAULT 0,     -- 5352 ← 真实余额
    role TEXT                      -- admin
);
```

### 💾 后端内存 (server.js)
```javascript
// 全局变量 - 游客余额 (不持久化)
global.guestBalances = new Map()
// 'admin-user-123' → 9909 (仅在内存中)

// 全局变量 - 用户ID映射
const userIdMappings = new Map()
// 'admin-user-123' → 'admin-user-123' (不转换)
```

### 🌐 前端存储
```javascript
// localStorage
localStorage.setItem('currentUser', JSON.stringify({
    id: 'admin-user-123',      // ← 错误的ID！
    email: 'lobos54321@gmail.com',
    balance: 100               // ← 缓存的错误值
}))

localStorage.setItem('dify_user_id', 'admin-user-123')

// authService 内存
authService.currentUser = {
    id: 'admin-user-123',
    balance: 100
}
```

---

## 🐛 问题诊断

### 当前问题路径：

```
localStorage 存储错误ID: 'admin-user-123'
    ↓
前端发送请求时使用这个ID
    ↓
后端接收到 'admin-user-123'
    ↓
尝试查询数据库: WHERE id = 'admin-user-123'
    ↓
❌ 失败: "invalid input syntax for type uuid"
    ↓
后端判定为游客用户
    ↓
积分扣除到内存 (不保存数据库)
    ↓
前端收到假的余额更新
    ↓
显示错误的余额
```

### 正确流程应该是：

```
localStorage 存储正确UUID: '9dee4891-89a6-44ee-8fe8-69097846e97d'
    ↓
前端发送请求时使用这个UUID
    ↓
后端接收到正确UUID
    ↓
查询数据库成功: balance = 5352
    ↓
扣除积分: 5352 - 91 = 5261
    ↓
UPDATE users SET balance = 5261
    ↓
前端收到真实余额: 5261
    ↓
✅ 显示正确余额
```

---

## 🔧 涉及的文件清单

### 后端
- `server.js:673-920` - handleTokenBilling() 积分扣除核心逻辑
- `server.js:144-165` - getValidUserId() 用户ID验证
- `server.js:1400+` - API路由处理

### 前端
- `src/lib/auth.ts` - 用户认证和余额管理
- `src/lib/supabase.ts` - 数据库操作
- `src/components/chat/DifyChatInterface.tsx:1857+` - 接收余额更新
- `src/components/ui/PointsDisplay.tsx` - 显示余额
- `src/components/layout/Navbar.tsx` - 顶部余额显示

### 数据库
- `users` 表 - 存储用户真实余额
- `token_usage` 表 - 记录使用历史（可选）

---

## ✅ 修复方案

清除错误的 localStorage 缓存，重新登录获取正确的UUID：

```javascript
localStorage.clear();
location.href = '/login';
```

登录后，正确的数据流：
1. 数据库 users.balance = 5352
2. localStorage.currentUser.id = '9dee4891-...' (UUID)
3. 发送消息时传正确UUID
4. 后端成功查询用户
5. 扣除积分并保存数据库
6. 前端显示正确余额
