# ç§¯åˆ†ç³»ç»Ÿå®Œæ•´æµç¨‹å›¾

## 1ï¸âƒ£ ç”¨æˆ·ç™»å½• - ä½™é¢è·å–æµç¨‹

```
ç”¨æˆ·ç™»å½•
    â†“
src/lib/auth.ts: login()
    â†“
src/lib/supabase.ts: signIn()
    â†“
è°ƒç”¨ Supabase Auth API éªŒè¯å¯†ç 
    â†“
æŸ¥è¯¢ users è¡¨è·å–ç”¨æˆ·ä¿¡æ¯
    â†“
SELECT id, email, name, role, balance FROM users WHERE id = 'ç”¨æˆ·UUID'
    â†“
è¿”å›ç”¨æˆ·å¯¹è±¡: { id, email, name, role, balance: 5352 }
    â†“
auth.ts ä¿å­˜åˆ°å†…å­˜: this.currentUser = user
    â†“
ä¿å­˜åˆ° localStorage: 
    localStorage.setItem('currentUser', JSON.stringify({
        id: '9dee4891-89a6-44ee-8fe8-69097846e97d',
        email: 'lobos54321@gmail.com',
        balance: 5352  // â† è¿™é‡Œæ˜¯æ•°æ®åº“çš„çœŸå®ä½™é¢
    }))
    â†“
è§¦å‘äº‹ä»¶: window.dispatchEvent('auth-state-changed')
    â†“
Navbar å’Œ PointsDisplay ç»„ä»¶ç›‘å¬åˆ°äº‹ä»¶
    â†“
æ˜¾ç¤ºä½™é¢: 5352 ç§¯åˆ†
```

---

## 2ï¸âƒ£ å‘é€æ¶ˆæ¯ - ç§¯åˆ†æ‰£é™¤æµç¨‹

```
ç”¨æˆ·åœ¨èŠå¤©ç•Œé¢è¾“å…¥æ¶ˆæ¯å¹¶å‘é€
    â†“
src/components/chat/DifyChatInterface.tsx: sendMessage()
    â”‚
    â”œâ”€ è·å–ç”¨æˆ·ID: 
    â”‚   const userId = user?.id || localStorage.getItem('dify_user_id')
    â”‚   // åº”è¯¥æ˜¯: '9dee4891-89a6-44ee-8fe8-69097846e97d'
    â”‚   // ä½†ä½ çš„æ˜¯: 'admin-user-123' â† é—®é¢˜æ‰€åœ¨ï¼
    â”‚
    â”œâ”€ å‡†å¤‡è¯·æ±‚æ•°æ®:
    â”‚   { message: 'ç”¨æˆ·æ¶ˆæ¯', userId: userId, conversationId: xxx }
    â”‚
    â””â”€ å‘é€ HTTP è¯·æ±‚:
        â†“
    POST /api/dify/chat-messages (æµå¼æ¨¡å¼)
    æˆ–
    POST /api/dify/workflows/run (å·¥ä½œæµæ¨¡å¼)
        â†“
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ã€åç«¯å¤„ç† - server.jsã€‘
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â†“
    ç¬¬1æ­¥: æ¥æ”¶è¯·æ±‚ (server.js:1400+)
        const { message, userId, conversationId } = req.body
        console.log('æ”¶åˆ°ç”¨æˆ·è¯·æ±‚:', userId)
        // userId = 'admin-user-123' â† é”™è¯¯çš„IDä¼ åˆ°åç«¯ï¼
        â†“
    ç¬¬2æ­¥: è°ƒç”¨ Dify API
        fetch('https://api.dify.ai/v1/chat-messages', {
            method: 'POST',
            body: JSON.stringify({
                query: message,
                user: userId,  // â† ä¼ ç»™Dify
                conversation_id: conversationId
            })
        })
        â†“
    ç¬¬3æ­¥: æ¥æ”¶ Dify å“åº” (æµå¼)
        data: {"event": "message", "answer": "å›ç­”å†…å®¹..."}
        data: {"event": "message_end", "metadata": {
            "usage": {
                "total_tokens": 4163,        â† Tokenæ•°é‡
                "prompt_tokens": 3500,
                "completion_tokens": 663,
                "total_price": 0.00905475   â† å®é™…æˆæœ¬
            }
        }}
        â†“
    ç¬¬4æ­¥: è°ƒç”¨ç§¯åˆ†æ‰£é™¤å‡½æ•° (server.js:1848)
        const billingInfo = await handleTokenBilling(
            finalData,           // Difyå“åº”æ•°æ®
            userId,              // 'admin-user-123' â† é”™è¯¯IDï¼
            'WORKFLOW_STREAM'
        )
        â†“
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ã€ç§¯åˆ†è®¡ç®—ä¸æ‰£é™¤ - server.js:673-920ã€‘
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â†“
    handleTokenBilling() å‡½æ•°æ‰§è¡Œ:
        â†“
    5-1: æå– Token æ•°æ®
        const totalTokens = responseData.metadata.usage.total_tokens  // 4163
        const actualCost = responseData.metadata.usage.total_price    // 0.00905475
        â†“
    5-2: è®¡ç®—æ‰£é™¤ç§¯åˆ†
        const pointsToDeduct = Math.ceil(actualCost * 10000)
        // 0.00905475 * 10000 = 90.5475 â†’ 91 ç§¯åˆ†
        console.log('ğŸ’° éœ€è¦æ‰£é™¤ 91 ç§¯åˆ†')
        â†“
    5-3: è·å–æœ‰æ•ˆç”¨æˆ·ID (server.js:734)
        const userId = getValidUserId(user)
        // getValidUserId('admin-user-123')
        // â†’ æ£€æŸ¥æ˜¯å¦æ˜¯UUID: âŒ ä¸æ˜¯ï¼
        // â†’ è¿”å›: 'admin-user-123' (ä¸è½¬æ¢)
        â†“
    5-4: æŸ¥è¯¢æ•°æ®åº“ä¸­çš„ç”¨æˆ· (server.js:743-747)
        const { data: userBalance, error } = await supabase
            .from('users')
            .select('balance')
            .eq('id', 'admin-user-123')  â† é”™è¯¯çš„IDï¼
            .single()
        â†“
    5-5: æ•°æ®åº“æŸ¥è¯¢å¤±è´¥ï¼(server.js:749-792)
        âŒ balanceError: "invalid input syntax for type uuid"
        
        console.log('âš ï¸ User not found in database: admin-user-123')
        console.log('ğŸ’¡ Creating guest user session')
        console.log('âš ï¸ Guest user - no points deducted')
        
        // åœ¨å†…å­˜ä¸­è®°å½•æ¸¸å®¢ä½™é¢ï¼ˆä¸ä¿å­˜åˆ°æ•°æ®åº“ï¼‰
        global.guestBalances.set('admin-user-123', 10000 - 91)
        
        return {
            tokens: 4163,
            points: 91,
            newBalance: 9909,  // å†…å­˜ä¸­çš„å‡ä½™é¢
            success: true,
            isGuest: true      // â† æ ‡è®°ä¸ºæ¸¸å®¢ï¼
        }
        â†“
    ã€å¦‚æœç”¨æˆ·IDæ­£ç¡®ï¼Œåº”è¯¥æ‰§è¡Œè¿™ä¸ªåˆ†æ”¯ã€‘
    5-6: æ­£å¸¸æ‰£é™¤ç§¯åˆ† (server.js:793-850)
        const currentBalance = userBalance.balance  // 5352
        const newBalance = currentBalance - 91      // 5261
        
        // æ›´æ–°æ•°æ®åº“
        UPDATE users SET balance = 5261 WHERE id = '9dee4891-...'
        
        console.log('âœ… Deducted 91 points. Balance: 5352 â†’ 5261')
        
        return {
            tokens: 4163,
            points: 91,
            newBalance: 5261,
            success: true,
            isGuest: false
        }
        â†“
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ã€è¿”å›å‰ç«¯ã€‘
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â†“
    ç¬¬6æ­¥: å‘é€ä½™é¢æ›´æ–°äº‹ä»¶ç»™å‰ç«¯ (server.js:1886-1898)
        res.write(`data: ${JSON.stringify({
            event: 'balance_updated',
            data: {
                newBalance: billingInfo.newBalance,  // 9909 (æ¸¸å®¢) æˆ– 5261 (çœŸå®)
                pointsDeducted: billingInfo.points,  // 91
                tokens: billingInfo.tokens           // 4163
            }
        })}\n\n`)
        â†“
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    ã€å‰ç«¯æ¥æ”¶æ›´æ–°ã€‘
    â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        â†“
    DifyChatInterface.tsx:1857 ç›‘å¬ SSE äº‹ä»¶
        if (parsed.event === 'balance_updated') {
            console.log('æ”¶åˆ°ä½™é¢æ›´æ–°:', parsed.data.newBalance)
            
            // æ›´æ–° authService
            const currentUser = authService.getCurrentUserSync()
            currentUser.balance = parsed.data.newBalance
            
            // æ›´æ–° localStorage
            localStorage.setItem('currentUser', JSON.stringify(currentUser))
            
            // è§¦å‘å…¨å±€äº‹ä»¶
            window.dispatchEvent(new CustomEvent('balance-updated', {
                detail: { balance: parsed.data.newBalance }
            }))
        }
        â†“
    PointsDisplay.tsx:57 ç›‘å¬ 'balance-updated' äº‹ä»¶
        setUser(prev => ({ ...prev, balance: newBalance }))
        
        // æ˜¾ç¤º Toast é€šçŸ¥
        toast.success(`âœ… æ¶ˆè´¹ ${tokens} tokens (${points} ç§¯åˆ†)`)
        â†“
    ç•Œé¢æ›´æ–°: æ˜¾ç¤ºæ–°ä½™é¢
```

---

## 3ï¸âƒ£ æ•°æ®å­˜å‚¨ä½ç½®

### ğŸ“ æ•°æ®åº“ (Supabase)
```sql
-- users è¡¨
CREATE TABLE users (
    id UUID PRIMARY KEY,           -- 9dee4891-89a6-44ee-8fe8-69097846e97d
    email TEXT,                    -- lobos54321@gmail.com
    name TEXT,                     -- Admin User
    balance INTEGER DEFAULT 0,     -- 5352 â† çœŸå®ä½™é¢
    role TEXT                      -- admin
);
```

### ğŸ’¾ åç«¯å†…å­˜ (server.js)
```javascript
// å…¨å±€å˜é‡ - æ¸¸å®¢ä½™é¢ (ä¸æŒä¹…åŒ–)
global.guestBalances = new Map()
// 'admin-user-123' â†’ 9909 (ä»…åœ¨å†…å­˜ä¸­)

// å…¨å±€å˜é‡ - ç”¨æˆ·IDæ˜ å°„
const userIdMappings = new Map()
// 'admin-user-123' â†’ 'admin-user-123' (ä¸è½¬æ¢)
```

### ğŸŒ å‰ç«¯å­˜å‚¨
```javascript
// localStorage
localStorage.setItem('currentUser', JSON.stringify({
    id: 'admin-user-123',      // â† é”™è¯¯çš„IDï¼
    email: 'lobos54321@gmail.com',
    balance: 100               // â† ç¼“å­˜çš„é”™è¯¯å€¼
}))

localStorage.setItem('dify_user_id', 'admin-user-123')

// authService å†…å­˜
authService.currentUser = {
    id: 'admin-user-123',
    balance: 100
}
```

---

## ğŸ› é—®é¢˜è¯Šæ–­

### å½“å‰é—®é¢˜è·¯å¾„ï¼š

```
localStorage å­˜å‚¨é”™è¯¯ID: 'admin-user-123'
    â†“
å‰ç«¯å‘é€è¯·æ±‚æ—¶ä½¿ç”¨è¿™ä¸ªID
    â†“
åç«¯æ¥æ”¶åˆ° 'admin-user-123'
    â†“
å°è¯•æŸ¥è¯¢æ•°æ®åº“: WHERE id = 'admin-user-123'
    â†“
âŒ å¤±è´¥: "invalid input syntax for type uuid"
    â†“
åç«¯åˆ¤å®šä¸ºæ¸¸å®¢ç”¨æˆ·
    â†“
ç§¯åˆ†æ‰£é™¤åˆ°å†…å­˜ (ä¸ä¿å­˜æ•°æ®åº“)
    â†“
å‰ç«¯æ”¶åˆ°å‡çš„ä½™é¢æ›´æ–°
    â†“
æ˜¾ç¤ºé”™è¯¯çš„ä½™é¢
```

### æ­£ç¡®æµç¨‹åº”è¯¥æ˜¯ï¼š

```
localStorage å­˜å‚¨æ­£ç¡®UUID: '9dee4891-89a6-44ee-8fe8-69097846e97d'
    â†“
å‰ç«¯å‘é€è¯·æ±‚æ—¶ä½¿ç”¨è¿™ä¸ªUUID
    â†“
åç«¯æ¥æ”¶åˆ°æ­£ç¡®UUID
    â†“
æŸ¥è¯¢æ•°æ®åº“æˆåŠŸ: balance = 5352
    â†“
æ‰£é™¤ç§¯åˆ†: 5352 - 91 = 5261
    â†“
UPDATE users SET balance = 5261
    â†“
å‰ç«¯æ”¶åˆ°çœŸå®ä½™é¢: 5261
    â†“
âœ… æ˜¾ç¤ºæ­£ç¡®ä½™é¢
```

---

## ğŸ”§ æ¶‰åŠçš„æ–‡ä»¶æ¸…å•

### åç«¯
- `server.js:673-920` - handleTokenBilling() ç§¯åˆ†æ‰£é™¤æ ¸å¿ƒé€»è¾‘
- `server.js:144-165` - getValidUserId() ç”¨æˆ·IDéªŒè¯
- `server.js:1400+` - APIè·¯ç”±å¤„ç†

### å‰ç«¯
- `src/lib/auth.ts` - ç”¨æˆ·è®¤è¯å’Œä½™é¢ç®¡ç†
- `src/lib/supabase.ts` - æ•°æ®åº“æ“ä½œ
- `src/components/chat/DifyChatInterface.tsx:1857+` - æ¥æ”¶ä½™é¢æ›´æ–°
- `src/components/ui/PointsDisplay.tsx` - æ˜¾ç¤ºä½™é¢
- `src/components/layout/Navbar.tsx` - é¡¶éƒ¨ä½™é¢æ˜¾ç¤º

### æ•°æ®åº“
- `users` è¡¨ - å­˜å‚¨ç”¨æˆ·çœŸå®ä½™é¢
- `token_usage` è¡¨ - è®°å½•ä½¿ç”¨å†å²ï¼ˆå¯é€‰ï¼‰

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

æ¸…é™¤é”™è¯¯çš„ localStorage ç¼“å­˜ï¼Œé‡æ–°ç™»å½•è·å–æ­£ç¡®çš„UUIDï¼š

```javascript
localStorage.clear();
location.href = '/login';
```

ç™»å½•åï¼Œæ­£ç¡®çš„æ•°æ®æµï¼š
1. æ•°æ®åº“ users.balance = 5352
2. localStorage.currentUser.id = '9dee4891-...' (UUID)
3. å‘é€æ¶ˆæ¯æ—¶ä¼ æ­£ç¡®UUID
4. åç«¯æˆåŠŸæŸ¥è¯¢ç”¨æˆ·
5. æ‰£é™¤ç§¯åˆ†å¹¶ä¿å­˜æ•°æ®åº“
6. å‰ç«¯æ˜¾ç¤ºæ­£ç¡®ä½™é¢
