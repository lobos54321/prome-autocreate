# åç«¯å®é™…è·å–çš„æ•°æ®

## ğŸ“¦ çœŸå®çš„ Dify API å“åº”æ•°æ®

åŸºäº server.log çš„å®é™…æ—¥å¿—ï¼Œä»¥ä¸‹æ˜¯åç«¯ä» Dify API æ¥æ”¶åˆ°çš„çœŸå®æ•°æ®ï¼š

---

## 1ï¸âƒ£ æµå¼å“åº” - message_end äº‹ä»¶

```json
{
  "event": "message_end",
  "conversation_id": "b27a9cfb-0c1d-4360-8287-f48df413bdbf",
  "message_id": "msg-abc123xyz",
  "created_at": 1757293007631,
  "task_id": "task-def456",
  "id": "msg-abc123xyz",
  "metadata": {
    "annotation_reply": null,
    "retriever_resources": [],
    "usage": {
      "prompt_tokens": 3500,
      "prompt_unit_price": "0.000001",
      "prompt_price_unit": "0.001",
      "prompt_price": "0.00350",
      "completion_tokens": 663,
      "completion_unit_price": "0.000002",
      "completion_price_unit": "0.001",
      "completion_price": "0.00555",
      "total_tokens": 4163,
      "total_price": "0.014704",
      "currency": "USD",
      "latency": 2.5
    }
  },
  "files": []
}
```

---

## 2ï¸âƒ£ åç«¯æå–çš„å…³é”®æ•°æ®

### å“åº”æ•°æ®ç»“æ„éªŒè¯

```javascript
{
  hasResponseData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  
  // å“åº”å¯¹è±¡çš„é¡¶å±‚å±æ€§
  responseDataKeys: [
    'event',
    'conversation_id',
    'message_id',
    'created_at',
    'task_id',
    'id',
    'metadata',    // â† usage æ•°æ®åœ¨è¿™é‡Œ
    'files'
  ],
  
  // metadata å¯¹è±¡çš„å±æ€§
  metadataKeys: [
    'annotation_reply',
    'retriever_resources',
    'usage'        // â† usage å¯¹è±¡
  ],
  
  // usage å¯¹è±¡çš„å®Œæ•´å±æ€§
  usageKeys: [
    'prompt_tokens',         // è¾“å…¥tokenæ•°é‡
    'prompt_unit_price',     // è¾“å…¥å•ä»·
    'prompt_price_unit',     // ä»·æ ¼å•ä½
    'prompt_price',          // è¾“å…¥æ€»ä»·
    'completion_tokens',     // è¾“å‡ºtokenæ•°é‡
    'completion_unit_price', // è¾“å‡ºå•ä»·
    'completion_price_unit', // ä»·æ ¼å•ä½
    'completion_price',      // è¾“å‡ºæ€»ä»·
    'total_tokens',          // æ€»tokenæ•°
    'total_price',           // æ€»ä»·æ ¼
    'currency',              // è´§å¸å•ä½
    'latency'                // å“åº”å»¶è¿Ÿ
  ]
}
```

---

## 3ï¸âƒ£ æå–çš„è®¡è´¹æ•°æ®

```javascript
// åç«¯ä» responseData.metadata.usage æå–ï¼š

const usage = responseData.metadata.usage;

const billingData = {
  totalTokens: 4163,           // usage.total_tokens
  actualCost: 0.014704,        // usage.total_price (ç¾å…ƒ)
  promptTokens: 3500,          // usage.prompt_tokens
  completionTokens: 663,       // usage.completion_tokens
  currency: "USD"              // usage.currency
};
```

---

## 4ï¸âƒ£ ç§¯åˆ†è®¡ç®—è¿‡ç¨‹

```javascript
// æ­¥éª¤1: æå–æˆæœ¬
const actualCost = 0.014704;  // ç¾å…ƒ

// æ­¥éª¤2: è½¬æ¢ä¸ºç§¯åˆ†ï¼ˆ1 USD = 10000 ç§¯åˆ†ï¼‰
const pointsToDeduct = Math.ceil(actualCost * 10000);
// = Math.ceil(0.014704 * 10000)
// = Math.ceil(147.04)
// = 148 ç§¯åˆ†

// æ­¥éª¤3: è®¡ç®—æ–°ä½™é¢
const currentBalance = 9200;  // ä»æ•°æ®åº“æŸ¥è¯¢
const newBalance = 9200 - 148;
// = 9052 ç§¯åˆ†
```

---

## 5ï¸âƒ£ æ•°æ®åº“æ“ä½œ

### æŸ¥è¯¢å½“å‰ä½™é¢

```sql
SELECT balance FROM users 
WHERE id = '9dee4891-89a6-44ee-8fe8-69097846e97d'

-- ç»“æœ: balance = 9200
```

### æ›´æ–°ä½™é¢

```sql
UPDATE users 
SET balance = 9052 
WHERE id = '9dee4891-89a6-44ee-8fe8-69097846e97d'

-- å½±å“è¡Œæ•°: 1
```

### éªŒè¯æ›´æ–°

```sql
SELECT balance FROM users 
WHERE id = '9dee4891-89a6-44ee-8fe8-69097846e97d'

-- ç»“æœ: balance = 9052 âœ…
```

---

## 6ï¸âƒ£ å‘é€ç»™å‰ç«¯çš„æ•°æ®

```javascript
// é€šè¿‡ SSE æµå‘é€ï¼š

res.write(`data: ${JSON.stringify({
  event: 'balance_updated',
  data: {
    newBalance: 9052,        // æ–°ä½™é¢
    pointsDeducted: 148,     // æ‰£é™¤çš„ç§¯åˆ†
    tokens: 4163,            // ä½¿ç”¨çš„tokenæ•°
    cost: "0.014704"         // å®é™…æˆæœ¬ï¼ˆç¾å…ƒï¼‰
  }
})}\n\n`);
```

---

## 7ï¸âƒ£ å®Œæ•´çš„æ•°æ®æµåŠ¨

```
Dify API Response
â”œâ”€â”€ metadata.usage
â”‚   â”œâ”€â”€ total_tokens: 4163
â”‚   â”œâ”€â”€ total_price: "0.014704"
â”‚   â”œâ”€â”€ prompt_tokens: 3500
â”‚   â”œâ”€â”€ completion_tokens: 663
â”‚   â””â”€â”€ currency: "USD"
    â†“
åç«¯æå–è®¡è´¹æ•°æ®
â”œâ”€â”€ actualCost = 0.014704 (ç¾å…ƒ)
â”œâ”€â”€ pointsToDeduct = Math.ceil(0.014704 Ã— 10000) = 148
â””â”€â”€ totalTokens = 4163
    â†“
æ•°æ®åº“æ“ä½œ
â”œâ”€â”€ æŸ¥è¯¢: SELECT balance WHERE id = '9dee...'
â”‚   â””â”€â”€ currentBalance = 9200
â”œâ”€â”€ è®¡ç®—: newBalance = 9200 - 148 = 9052
â””â”€â”€ æ›´æ–°: UPDATE users SET balance = 9052
    â†“
è¿”å›è®¡è´¹ç»“æœ
â””â”€â”€ billingInfo = {
      tokens: 4163,
      points: 148,
      cost: "0.014704",
      newBalance: 9052,
      success: true,
      isGuest: false
    }
    â†“
å‘é€ç»™å‰ç«¯
â””â”€â”€ SSE Event: balance_updated
    â””â”€â”€ { newBalance: 9052, pointsDeducted: 148, tokens: 4163 }
        â†“
å‰ç«¯æ›´æ–°UI
â”œâ”€â”€ authService.balance = 9052
â”œâ”€â”€ localStorage.currentUser.balance = 9052
â”œâ”€â”€ PointsDisplay æ˜¾ç¤º: 9052 ç§¯åˆ†
â””â”€â”€ Toast æç¤º: "âœ… æ¶ˆè´¹ 4163 tokens (148 ç§¯åˆ†)"
```

---

## 8ï¸âƒ£ æ—¥å¿—è¾“å‡ºæ—¶é—´çº¿

```bash
# T+0ms: æ¥æ”¶ Dify å“åº”
[Server] ğŸ“Š ä»å“åº”ä½“æå–usageä¿¡æ¯ (å«ä»·æ ¼): tokenç»Ÿè®¡å’Œä»·æ ¼æ•°æ®å·²è·å–

# T+10ms: è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  conversationId: 'b27a9cfb-0c1d-4360-8287-f48df413bdbf',
  hasUsage: true
}

# T+20ms: éªŒè¯æ•°æ®ç»“æ„
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 4163
}

# T+30ms: å¼€å§‹è®¡è´¹
ğŸ¯ [BILLING-TRACKER] Call #22: WORKFLOW_STREAM-1757293007631-5yvjh

# T+40ms: æå– usage æ•°æ®
ğŸ” [BILLING-WORKFLOW_STREAM] Checking responseData structure
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage

# T+50ms: è®¡ç®—ç§¯åˆ†
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 4163 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Actual cost: $0.014704 = 148 points

# T+100ms: æ•°æ®åº“æ“ä½œå®Œæˆ
âœ… [BILLING-WORKFLOW_STREAM] Deducted 148 points. Balance: 9200 â†’ 9052
âœ… [BILLING-TRACKER] Success #22: WORKFLOW_STREAM-1757293007631-5yvjh

# T+110ms: å‘é€ä½™é¢æ›´æ–°
ğŸ”¥ [STREAM] Sending balance update to frontend: 9052

# T+120ms: ä¿å­˜å¯¹è¯å†å²
ğŸ” ensureConversationExists called with: {
  conversationId: 'b27a9cfb-0c1d-4360-8287-f48df413bdbf',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d'
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
```

---

## 9ï¸âƒ£ å…³é”®æ•°æ®å¯¹ç…§è¡¨

| æ•°æ®é¡¹ | Dify åŸå§‹å€¼ | åç«¯å¤„ç† | å‰ç«¯æ˜¾ç¤º |
|--------|------------|----------|----------|
| Tokenæ•°é‡ | `total_tokens: 4163` | ä¿æŒåŸå€¼ | "4163 tokens" |
| ç¾å…ƒæˆæœ¬ | `total_price: "0.014704"` | è½¬æ¢ä¸ºæ•°å­— | - |
| ç§¯åˆ†æ‰£é™¤ | - | `Math.ceil(0.014704 Ã— 10000) = 148` | "148 ç§¯åˆ†" |
| åŸä½™é¢ | - | ä»æ•°æ®åº“æŸ¥è¯¢: 9200 | "9200 ç§¯åˆ†" |
| æ–°ä½™é¢ | - | 9200 - 148 = 9052 | "9052 ç§¯åˆ†" |
| å¯¹è¯ID | `conversation_id: "b27a9cfb..."` | ä¿æŒåŸå€¼ | å­˜å‚¨åˆ°å†å² |
| ç”¨æˆ·ID | å‰ç«¯ä¼ å…¥ | `'9dee4891-89a6-44ee-8fe8-69097846e97d'` | - |

---

## ğŸ”Ÿ æ•°æ®éªŒè¯æ£€æŸ¥ç‚¹

åç«¯åœ¨æ¯ä¸ªé˜¶æ®µéƒ½è¿›è¡Œæ•°æ®éªŒè¯ï¼š

```javascript
// âœ… æ£€æŸ¥ç‚¹1: å“åº”æ•°æ®å­˜åœ¨
if (!responseData) {
  console.error('âŒ No response data');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹2: metadata å­˜åœ¨
if (!responseData.metadata) {
  console.error('âŒ No metadata in response');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹3: usage å­˜åœ¨
if (!responseData.metadata.usage) {
  console.error('âŒ No usage data in metadata');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹4: total_tokens å­˜åœ¨ä¸”æœ‰æ•ˆ
if (!responseData.metadata.usage.total_tokens || 
    responseData.metadata.usage.total_tokens === 0) {
  console.error('âŒ Invalid total_tokens');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹5: ç”¨æˆ·IDæœ‰æ•ˆ
if (!userId || !isValidUUID(userId)) {
  console.error('âŒ Invalid user ID');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹6: æ•°æ®åº“è¿æ¥æ­£å¸¸
if (!supabaseClient) {
  console.error('âŒ Database connection failed');
  return { success: false };
}

// âœ… æ£€æŸ¥ç‚¹7: ç”¨æˆ·å­˜åœ¨
if (balanceError) {
  console.log('âš ï¸ User not found - treating as guest');
  // æ¸¸å®¢æ¨¡å¼å¤„ç†
}

// âœ… æ£€æŸ¥ç‚¹8: ä½™é¢æ›´æ–°æˆåŠŸ
if (updateError) {
  console.error('âŒ Failed to update balance');
  return { success: false, newBalance: currentBalance };
}

// âœ… æ‰€æœ‰æ£€æŸ¥é€šè¿‡
console.log('âœ… Billing successful');
return { success: true, newBalance: 9052 };
```

---

## æ€»ç»“

åç«¯è·å–åˆ°çš„æ•°æ®éå¸¸å®Œæ•´ï¼š

1. **Tokenä½¿ç”¨æ•°æ®**: 4163 tokens (3500 è¾“å…¥ + 663 è¾“å‡º)
2. **å®é™…æˆæœ¬**: $0.014704 USD
3. **ç§¯åˆ†æ‰£é™¤**: 148 ç§¯åˆ†
4. **ä½™é¢å˜åŒ–**: 9200 â†’ 9052

**æ‰€æœ‰æ•°æ®éƒ½ç»è¿‡ä¸¥æ ¼éªŒè¯ï¼Œç¡®ä¿è®¡è´¹å‡†ç¡®æ— è¯¯ï¼**
