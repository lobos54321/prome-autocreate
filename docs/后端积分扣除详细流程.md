# åç«¯ç§¯åˆ†æ‰£é™¤è¯¦ç»†æµç¨‹

## ğŸ“‹ å®Œæ•´æµç¨‹å›¾

```
ç”¨æˆ·åœ¨å‰ç«¯å‘é€æ¶ˆæ¯
    â†“
å‰ç«¯: POST /api/dify/chat-messages { message, userId, conversationId }
    â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€åç«¯ server.js - æµå¼å“åº”æ¨¡å¼ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

ç¬¬1æ­¥: æ¥æ”¶è¯·æ±‚å¹¶è½¬å‘ç»™ Dify API
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1400-1500

app.post('/api/dify/chat-messages', async (req, res) => {
  const { message, userId, conversationId } = req.body;
  
  // è®¾ç½®SSEå“åº”å¤´
  res.setHeader('Content-Type', 'text/event-stream');
  res.setHeader('Cache-Control', 'no-cache');
  
  // è½¬å‘è¯·æ±‚åˆ° Dify API
  const difyResponse = await fetch('https://api.dify.ai/v1/chat-messages', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${DIFY_API_KEY}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      query: message,
      user: userId,
      conversation_id: conversationId,
      response_mode: 'streaming'  // â† æµå¼æ¨¡å¼
    })
  });
  
  // ç»§ç»­å¤„ç†æµå¼å“åº”...
})
    â†“

ç¬¬2æ­¥: æ¥æ”¶å¹¶è§£æ Dify æµå¼å“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1600-1800

Dify API è¿”å› SSE æµå¼æ•°æ®ï¼š

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ data: {"event": "message", "answer": "ä½ å¥½"}        â”‚  â† æ¶ˆæ¯å—
â”‚ data: {"event": "message", "answer": "ï¼Œæˆ‘æ˜¯AI"}    â”‚  â† æ¶ˆæ¯å—
â”‚ data: {"event": "message_end", "metadata": {...}}   â”‚  â† ç»“æŸäº‹ä»¶
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

åç«¯é€è¡Œè§£æï¼š

const reader = difyResponse.body.getReader();
const decoder = new TextDecoder();

while (true) {
  const { done, value } = await reader.read();
  if (done) break;
  
  const chunk = decoder.decode(value);
  const lines = chunk.split('\n');
  
  for (const line of lines) {
    if (line.startsWith('data: ')) {
      const data = line.slice(6);
      
      if (data === '[DONE]') {
        // æµç»“æŸï¼Œå‡†å¤‡è®¡è´¹
        break;
      }
      
      const parsed = JSON.parse(data);
      
      // è½¬å‘ç»™å‰ç«¯
      res.write(`data: ${data}\n\n`);
      
      // æ”¶é›†å®Œæ•´å“åº”æ•°æ®
      if (parsed.event === 'message') {
        fullAnswer += parsed.answer;  // ç´¯ç§¯å›ç­”å†…å®¹
      }
      
      if (parsed.event === 'message_end') {
        // ğŸ¯ å…³é”®ï¼šä¿å­˜ metadataï¼ŒåŒ…å« usage æ•°æ®
        finalData = {
          answer: fullAnswer,
          conversation_id: parsed.conversation_id,
          message_id: parsed.message_id,
          metadata: parsed.metadata  // â† åŒ…å« usage ä¿¡æ¯ï¼
        };
      }
    }
  }
}
    â†“

ç¬¬3æ­¥: æå– Token ä½¿ç”¨æ•°æ®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1800-1850

æµç»“æŸåï¼ŒfinalData åŒ…å«å®Œæ•´çš„ metadataï¼š

finalData = {
  answer: "å®Œæ•´çš„AIå›ç­”å†…å®¹",
  conversation_id: "b27a9cfb-0c1d-4360-8287-f48df413bdbf",
  message_id: "msg-abc123",
  metadata: {
    usage: {
      prompt_tokens: 3500,        // â† è¾“å…¥token
      completion_tokens: 663,     // â† è¾“å‡ºtoken
      total_tokens: 4163,         // â† æ€»token
      prompt_price: "0.00350",    // â† è¾“å…¥ä»·æ ¼ï¼ˆç¾å…ƒï¼‰
      completion_price: "0.00555",// â† è¾“å‡ºä»·æ ¼ï¼ˆç¾å…ƒï¼‰
      total_price: "0.00905475",  // â† æ€»ä»·æ ¼ï¼ˆç¾å…ƒï¼‰
      currency: "USD",
      latency: 2.5
    }
  }
}

console.log('ğŸ” [DEBUG] finalData structure for billing:', {
  hasMetadata: !!finalData.metadata,
  hasUsage: !!finalData.metadata?.usage,
  totalTokens: finalData.metadata?.usage?.total_tokens
});
    â†“

ç¬¬4æ­¥: è°ƒç”¨ç§¯åˆ†æ‰£é™¤å‡½æ•°
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1848

let billingInfo = await handleTokenBilling(
  finalData,           // åŒ…å« usage æ•°æ®
  userId,              // '9dee4891-89a6-44ee-8fe8-69097846e97d'
  'WORKFLOW_STREAM'    // ç«¯ç‚¹ç±»å‹æ ‡è¯†
);
    â†“
    â†“
    â†“ è¿›å…¥ handleTokenBilling() å‡½æ•°
    â†“
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€handleTokenBilling() æ ¸å¿ƒè®¡è´¹é€»è¾‘ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ä½ç½®: server.js:673-920

æ­¥éª¤ 4.1: æå– Usage æ•°æ®
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function handleTokenBilling(responseData, user, endpoint = 'unknown') {
  console.log(`ğŸ” [BILLING-${endpoint}] Checking responseData structure`);
  
  let totalTokens = null;
  let actualCost = null;
  let usage = null;

  // æ£€æŸ¥ metadata.usage (æ ‡å‡†ä½ç½®)
  if (responseData?.metadata?.usage?.total_tokens) {
    usage = responseData.metadata.usage;
    totalTokens = usage.total_tokens;        // 4163
    actualCost = Number(usage.total_price);  // 0.00905475
    
    console.log(`âœ… [BILLING-${endpoint}] Found usage in metadata.usage`);
    console.log(`ğŸ’° [BILLING-${endpoint}] Multi-node LLM: ${totalTokens} tokens`);
    console.log(`ğŸ’° [COST-${endpoint}] Actual cost: $${actualCost.toFixed(6)}`);
  }
  // å…¶ä»–ä½ç½®çš„fallbackæ£€æŸ¥ï¼ˆç•¥ï¼‰
  
  if (!totalTokens || totalTokens === 0) {
    console.error(`ğŸš¨ [BILLING-${endpoint}] No token data found!`);
    return { tokens: 0, success: false };
  }
    â†“

æ­¥éª¤ 4.2: è®¡ç®—æ‰£é™¤ç§¯åˆ†
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // ğŸ”§ æ ¸å¿ƒå…¬å¼ï¼šç¾å…ƒæˆæœ¬ Ã— 10000 = ç§¯åˆ†
  const pointsToDeduct = Math.ceil(actualCost * 10000);
  
  // ç¤ºä¾‹è®¡ç®—ï¼š
  // actualCost = 0.00905475
  // pointsToDeduct = Math.ceil(0.00905475 * 10000)
  //                = Math.ceil(90.5475)
  //                = 91 ç§¯åˆ†
  
  console.log(`ğŸ’° [COST-${endpoint}] Actual cost: $${actualCost.toFixed(6)} = ${pointsToDeduct} points`);
    â†“

æ­¥éª¤ 4.3: éªŒè¯ç”¨æˆ·ID
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const userId = getValidUserId(user);
  // userId = '9dee4891-89a6-44ee-8fe8-69097846e97d'
  
  // getValidUserId() å‡½æ•°æ£€æŸ¥ï¼š
  // 1. æ˜¯å¦æ˜¯æœ‰æ•ˆçš„UUIDæ ¼å¼
  // 2. å¦‚æœä¸æ˜¯UUIDï¼Œå°è¯•æå–æˆ–ç”ŸæˆUUID
    â†“

æ­¥éª¤ 4.4: è¿æ¥æ•°æ®åº“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const { createClient } = await import('@supabase/supabase-js');
  const supabaseClient = createClient(
    SUPABASE_URL,              // ä»ç¯å¢ƒå˜é‡
    SUPABASE_SERVICE_ROLE_KEY  // ä»ç¯å¢ƒå˜é‡ï¼ˆç®¡ç†å‘˜æƒé™ï¼‰
  );
    â†“

æ­¥éª¤ 4.5: æŸ¥è¯¢å½“å‰ä½™é¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const { data: userBalance, error: balanceError } = await supabaseClient
    .from('users')
    .select('balance')
    .eq('id', userId)
    .single();
  
  // SQL ç­‰ä»·äºï¼š
  // SELECT balance FROM users WHERE id = '9dee4891-89a6-44ee-8fe8-69097846e97d'
  
  if (balanceError) {
    // ç”¨æˆ·ä¸å­˜åœ¨ â†’ ä½œä¸ºæ¸¸å®¢å¤„ç†ï¼ˆä¸æ‰£æ•°æ®åº“ç§¯åˆ†ï¼‰
    console.log(`âš ï¸ [BILLING-${endpoint}] User not found in database: ${userId}`);
    
    // åœ¨å†…å­˜ä¸­è®°å½•æ¸¸å®¢ä½™é¢
    global.guestBalances.set(userId, 10000 - pointsToDeduct);
    
    return {
      tokens: totalTokens,
      points: pointsToDeduct,
      newBalance: 10000 - pointsToDeduct,
      success: true,
      isGuest: true  // â† æ ‡è®°ä¸ºæ¸¸å®¢
    };
  }
    â†“

æ­¥éª¤ 4.6: è®¡ç®—æ–°ä½™é¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const currentBalance = userBalance.balance;  // 5352
  const newBalance = Math.max(0, currentBalance - pointsToDeduct);
  
  // ç¤ºä¾‹ï¼š
  // currentBalance = 5352
  // pointsToDeduct = 91
  // newBalance = 5352 - 91 = 5261
  
  console.log(`ğŸ’° [BILLING-${endpoint}] Deduction: ${currentBalance} - ${pointsToDeduct} = ${newBalance}`);
    â†“

æ­¥éª¤ 4.7: æ›´æ–°æ•°æ®åº“ä½™é¢
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  const { error: updateError } = await supabaseClient
    .from('users')
    .update({ balance: newBalance })
    .eq('id', userId);
  
  // SQL ç­‰ä»·äºï¼š
  // UPDATE users SET balance = 5261 WHERE id = '9dee4891-89a6-44ee-8fe8-69097846e97d'
  
  if (updateError) {
    console.error(`âŒ [BILLING-${endpoint}] Failed to deduct points: ${updateError.message}`);
    return {
      tokens: totalTokens,
      points: pointsToDeduct,
      newBalance: currentBalance,  // å¤±è´¥æ—¶è¿”å›åŸä½™é¢
      success: false
    };
  }
  
  console.log(`âœ… [BILLING-${endpoint}] Deducted ${pointsToDeduct} points. Balance: ${currentBalance} â†’ ${newBalance}`);
    â†“

æ­¥éª¤ 4.8: è®°å½•ä½¿ç”¨å†å²ï¼ˆå¯é€‰ï¼‰
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  // å¯ä»¥è®°å½•åˆ° token_usage è¡¨
  await supabaseClient
    .from('token_usage')
    .insert({
      user_id: userId,
      tokens_used: totalTokens,
      points_used: pointsToDeduct,
      model_name: 'dify-workflow',
      conversation_id: conversationId,
      message_id: messageId,
      created_at: new Date().toISOString()
    });
    â†“

æ­¥éª¤ 4.9: è¿”å›è®¡è´¹ä¿¡æ¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  return {
    tokens: totalTokens,          // 4163
    points: pointsToDeduct,       // 91
    cost: actualCost.toFixed(6),  // "0.009055"
    newBalance: newBalance,       // 5261
    success: true,
    isGuest: false
  };
}
    â†“
    â†“ è¿”å›åˆ°ä¸»æµç¨‹
    â†“

ç¬¬5æ­¥: å‘é€ä½™é¢æ›´æ–°äº‹ä»¶ç»™å‰ç«¯
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1886-1898

// billingInfo = { tokens: 4163, points: 91, newBalance: 5261, success: true }

if (billingInfo && billingInfo.newBalance !== null && billingInfo.success) {
  console.log(`ğŸ”¥ [STREAM] Sending balance update to frontend: ${billingInfo.newBalance}`);
  
  // é€šè¿‡ SSE æµå‘é€ç‰¹æ®Šäº‹ä»¶ç»™å‰ç«¯
  res.write(`data: ${JSON.stringify({
    event: 'balance_updated',  // â† ç‰¹æ®Šäº‹ä»¶ç±»å‹
    data: {
      newBalance: billingInfo.newBalance,      // 5261
      pointsDeducted: billingInfo.points,      // 91
      tokens: billingInfo.tokens,              // 4163
      cost: billingInfo.cost                   // "0.009055"
    }
  })}\n\n`);
}
    â†“

ç¬¬6æ­¥: ä¿å­˜å¯¹è¯å†å²åˆ°æ•°æ®åº“
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ“ ä½ç½®: server.js:1900-1906

const conversationCreated = await ensureConversationExists(
  supabase, 
  conversationId, 
  finalData.conversation_id, 
  userId
);

if (conversationCreated !== false) {
  await saveMessages(supabase, conversationId, message, finalData);
  console.log('âœ… Saved streaming conversation to database');
}
    â†“

ç¬¬7æ­¥: ç»“æŸæµå“åº”
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

res.write('data: [DONE]\n\n');
res.end();
    â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€å‰ç«¯æ¥æ”¶å’Œå¤„ç†ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ğŸ“ ä½ç½®: src/components/chat/DifyChatInterface.tsx:1857-1905

å‰ç«¯ç›‘å¬ SSE æµï¼š

const eventSource = new EventSource('/api/dify/chat-messages');

eventSource.onmessage = (event) => {
  const parsed = JSON.parse(event.data);
  
  // æ™®é€šæ¶ˆæ¯å—
  if (parsed.event === 'message') {
    appendToChat(parsed.answer);
  }
  
  // ğŸ¯ ä½™é¢æ›´æ–°äº‹ä»¶
  if (parsed.event === 'balance_updated') {
    console.log('ğŸ”¥ [Frontend] Received balance_updated:', parsed.data);
    
    // æ›´æ–° authService å†…å­˜
    const currentUser = authService.getCurrentUserSync();
    if (currentUser) {
      currentUser.balance = parsed.data.newBalance;  // 5261
    }
    
    // æ›´æ–° localStorage
    localStorage.setItem('currentUser', JSON.stringify(currentUser));
    
    // è§¦å‘å…¨å±€äº‹ä»¶ï¼Œé€šçŸ¥æ‰€æœ‰ç»„ä»¶
    window.dispatchEvent(new CustomEvent('balance-updated', {
      detail: { 
        balance: parsed.data.newBalance,      // 5261
        pointsDeducted: parsed.data.pointsDeducted,  // 91
        tokens: parsed.data.tokens            // 4163
      }
    }));
    
    // æ˜¾ç¤º Toast é€šçŸ¥
    toast.success(`âœ… æ¶ˆè´¹ ${parsed.data.tokens} tokens (${parsed.data.pointsDeducted} ç§¯åˆ†)`, {
      description: `ä½™é¢: ${parsed.data.newBalance} ç§¯åˆ†`
    });
  }
};
    â†“

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ã€UI ç»„ä»¶æ›´æ–°ã€‘
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

PointsDisplay ç»„ä»¶ç›‘å¬ 'balance-updated' äº‹ä»¶ï¼š

useEffect(() => {
  const handleBalanceUpdate = (event: CustomEvent) => {
    const newBalance = event.detail.balance;  // 5261
    
    setUser(prev => ({ 
      ...prev, 
      balance: newBalance 
    }));
    
    // æ·»åŠ åˆ°å†å²è®°å½•
    setPointsHistory(prev => [{
      change: -event.detail.pointsDeducted,  // -91
      timestamp: new Date().toISOString()
    }, ...prev]);
  };
  
  window.addEventListener('balance-updated', handleBalanceUpdate);
  
  return () => {
    window.removeEventListener('balance-updated', handleBalanceUpdate);
  };
}, []);
    â†“

ç•Œé¢æ˜¾ç¤ºæ›´æ–°ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ’° 5261 ç§¯åˆ†                       â”‚  â† å®æ—¶æ›´æ–°
â”‚  â‰ˆ $0.5261                         â”‚
â”‚                                     â”‚
â”‚  æœ€è¿‘ä½¿ç”¨:                          â”‚
â”‚  â€¢ åˆšåˆš: -91 ç§¯åˆ†                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ å…³é”®æŠ€æœ¯ç‚¹

### 1ï¸âƒ£ SSE (Server-Sent Events) æµå¼é€šä¿¡

```javascript
// åç«¯è®¾ç½® SSE å“åº”å¤´
res.setHeader('Content-Type', 'text/event-stream');
res.setHeader('Cache-Control', 'no-cache');
res.setHeader('Connection', 'keep-alive');

// å‘é€æ•°æ®
res.write(`data: ${JSON.stringify({ event: 'message', answer: '...' })}\n\n`);

// å‰ç«¯æ¥æ”¶
const eventSource = new EventSource('/api/dify/chat-messages');
eventSource.onmessage = (event) => {
  const parsed = JSON.parse(event.data);
  // å¤„ç†æ•°æ®
};
```

### 2ï¸âƒ£ Dify API Usage æ•°æ®ç»“æ„

```json
{
  "metadata": {
    "usage": {
      "prompt_tokens": 3500,
      "completion_tokens": 663,
      "total_tokens": 4163,
      "prompt_price": "0.00350",
      "completion_price": "0.00555",
      "total_price": "0.00905475",
      "currency": "USD",
      "latency": 2.5
    }
  }
}
```

### 3ï¸âƒ£ ç§¯åˆ†è®¡ç®—å…¬å¼

```javascript
// ç¾å…ƒ â†’ ç§¯åˆ†è½¬æ¢ç‡: 1 USD = 10000 ç§¯åˆ†
const pointsToDeduct = Math.ceil(actualCost * 10000);

// ç¤ºä¾‹ï¼š
// $0.00905475 Ã— 10000 = 90.5475 â†’ Math.ceil() â†’ 91 ç§¯åˆ†
```

### 4ï¸âƒ£ æ•°æ®åº“æ“ä½œï¼ˆSupabaseï¼‰

```javascript
// æŸ¥è¯¢ä½™é¢
const { data } = await supabase
  .from('users')
  .select('balance')
  .eq('id', userId)
  .single();

// æ›´æ–°ä½™é¢
await supabase
  .from('users')
  .update({ balance: newBalance })
  .eq('id', userId);
```

### 5ï¸âƒ£ æ¸¸å®¢ç”¨æˆ·å¤„ç†

```javascript
// å¦‚æœç”¨æˆ·ä¸åœ¨æ•°æ®åº“ä¸­
if (balanceError) {
  // åœ¨å†…å­˜ä¸­è®°å½•æ¸¸å®¢ä½™é¢ï¼ˆæœåŠ¡å™¨é‡å¯ä¼šä¸¢å¤±ï¼‰
  global.guestBalances = new Map();
  global.guestBalances.set(userId, 10000 - pointsToDeduct);
  
  return {
    isGuest: true,
    newBalance: 10000 - pointsToDeduct
  };
}
```

---

## ğŸ“Š æ•°æ®æµåŠ¨å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯      â”‚
â”‚ (æµè§ˆå™¨)    â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HTTP POST /api/dify/chat-messages
       â”‚ { message, userId, conversationId }
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯      â”‚
â”‚ (server.js) â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ HTTP POST https://api.dify.ai/v1/chat-messages
       â”‚ { query, user, response_mode: 'streaming' }
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Dify API   â”‚
â”‚ (å¤–éƒ¨æœåŠ¡)  â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â”‚
       â”‚ SSE Stream
       â”‚ â”œâ”€ data: {"event": "message", "answer": "..."}
       â”‚ â”œâ”€ data: {"event": "message", "answer": "..."}
       â”‚ â””â”€ data: {"event": "message_end", "metadata": {"usage": {...}}}
       â”‚
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯ handleTokenBilling()     â”‚
â”‚                                 â”‚
â”‚  1. æå– usage.total_tokens     â”‚
â”‚  2. è®¡ç®—ç§¯åˆ†: cost Ã— 10000      â”‚
â”‚  3. æŸ¥è¯¢æ•°æ®åº“å½“å‰ä½™é¢          â”‚
â”‚  4. è®¡ç®—æ–°ä½™é¢: old - points    â”‚
â”‚  5. UPDATE users SET balance    â”‚
â”‚  6. è¿”å› billingInfo            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ billingInfo = { newBalance: 5261, points: 91, tokens: 4163 }
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   åç«¯å‘é€ SSE äº‹ä»¶              â”‚
â”‚                                 â”‚
â”‚  res.write(`data: {             â”‚
â”‚    "event": "balance_updated",  â”‚
â”‚    "data": {                    â”‚
â”‚      "newBalance": 5261,        â”‚
â”‚      "pointsDeducted": 91       â”‚
â”‚    }                            â”‚
â”‚  }\n\n`)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ SSE Stream
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   å‰ç«¯ç›‘å¬ balance_updated       â”‚
â”‚                                 â”‚
â”‚  1. æ›´æ–° authService.balance    â”‚
â”‚  2. æ›´æ–° localStorage           â”‚
â”‚  3. è§¦å‘ balance-updated äº‹ä»¶   â”‚
â”‚  4. æ˜¾ç¤º Toast é€šçŸ¥             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚
         â”‚ CustomEvent('balance-updated')
         â”‚
         â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   UI ç»„ä»¶æ›´æ–°                   â”‚
â”‚                                 â”‚
â”‚  PointsDisplay: 5352 â†’ 5261     â”‚
â”‚  Navbar: æ›´æ–°ä½™é¢æ˜¾ç¤º           â”‚
â”‚  Toast: "æ¶ˆè´¹ 91 ç§¯åˆ†"          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ›¡ï¸ é”™è¯¯å¤„ç†æœºåˆ¶

### 1. Token æ•°æ®ç¼ºå¤±
```javascript
if (!totalTokens || totalTokens === 0) {
  console.error('ğŸš¨ No token data found!');
  // ä¸æ‰£é™¤ç§¯åˆ†ï¼Œè®°å½•é”™è¯¯
  return { tokens: 0, success: false };
}
```

### 2. ç”¨æˆ·ä¸å­˜åœ¨
```javascript
if (balanceError) {
  console.log('âš ï¸ User not found in database');
  // ä½œä¸ºæ¸¸å®¢å¤„ç†ï¼Œåœ¨å†…å­˜ä¸­è®°å½•
  return { isGuest: true, newBalance: 9909 };
}
```

### 3. æ•°æ®åº“æ›´æ–°å¤±è´¥
```javascript
if (updateError) {
  console.error('âŒ Failed to update balance');
  // è¿”å›åŸä½™é¢ï¼Œæ ‡è®°å¤±è´¥
  return { success: false, newBalance: currentBalance };
}
```

### 4. ä½™é¢ä¸è¶³
```javascript
const newBalance = Math.max(0, currentBalance - pointsToDeduct);
// ä½¿ç”¨ Math.max(0, ...) ç¡®ä¿ä½™é¢ä¸ä¸ºè´Ÿæ•°
```

---

## ğŸ“ æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```bash
# åç«¯æ§åˆ¶å°è¾“å‡ºï¼š

ğŸ” [BILLING-WORKFLOW_STREAM] Checking responseData structure
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 4163 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Actual cost: $0.009055 = 91 points
ğŸ’° [BILLING-WORKFLOW_STREAM] Deduction: 5352 - 91 = 5261
âœ… [BILLING-WORKFLOW_STREAM] Deducted 91 points. Balance: 5352 â†’ 5261
ğŸ”¥ [STREAM] Sending balance update to frontend: 5261
âœ… Saved streaming conversation to database
```

```bash
# å‰ç«¯æ§åˆ¶å°è¾“å‡ºï¼š

ğŸ”¥ [Frontend-Streaming] Received balance_updated from backend: {newBalance: 5261, pointsDeducted: 91, tokens: 4163}
âœ… [Frontend-Stream] Updated authService balance: 5261
ğŸ¯ [Event] balance-updated event dispatched for streaming mode
âœ… [PointsDisplay] Balance updated: {oldBalance: 5352, newBalance: 5261, difference: -91}
```

---

è¿™å°±æ˜¯å®Œæ•´çš„åç«¯ç§¯åˆ†æ‰£é™¤æµç¨‹ï¼**åç«¯å®Œå…¨è´Ÿè´£è®¡è´¹ï¼Œå‰ç«¯åªè´Ÿè´£æ¥æ”¶æ›´æ–°å’Œæ˜¾ç¤ºUI**ã€‚
