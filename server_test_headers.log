[dotenv@17.2.1] injecting env (19) from .env -- tip: ğŸ” prevent committing .env to code: https://dotenvx.com/precommit
ğŸš€ Starting Prome Platform server
âœ… Dify API environment variables are configured
Server is running on port 8080
ğŸ” Performing database health check...
âœ… Database health check passed - all required tables exist
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "3080adaa-7997-4962-af5d-6b71e757d573",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 3080adaa-7997-4962-af5d-6b71e757d573
ğŸ” Looking up conversation in database: 3080adaa-7997-4962-af5d-6b71e757d573
âœ… Found existing DIFY conversation: 3080adaa-7997-4962-af5d-6b71e757d573
ğŸ”„ Continuing existing conversation: 3080adaa-7997-4962-af5d-6b71e757d573
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '3080adaa-7997-4962-af5d-6b71e757d573',
  timestamp: '2025-10-02T01:38:50.528Z'
}
ğŸ“Š Context check: 33 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '98807b8d4d16aad1-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 01:38:52 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=kLz6kwtmmU%2Bh83oalgXNp9fiCgOd3Ew5jf%2B278c%2B9opKWllvKzbrs8Zfb8BPM%2BBW55U2HLePfnxXzlnomUgZ%2BU74ZXxMfmrd2hE%2BcApSQK%2B533SLwA8%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +346 tokens, $0.000848 (ç´¯è®¡: 346 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +471 tokens, $0.000978 (ç´¯è®¡: 817 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 817 tokens
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: false,
  tokensValue: 0,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759369136114-tzcsg
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: false,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
ğŸš¨ [BILLING-WORKFLOW_STREAM] NO TOKEN USAGE DATA FOUND! This interaction will not be billed!
ğŸš¨ [BILLING-WORKFLOW_STREAM] responseData structure: {
  "event": "message_end",
  "conversation_id": "3080adaa-7997-4962-af5d-6b71e757d573",
  "message_id": "5508822b-922e-43d3-a044-f30396c1baf3",
  "created_at": 1759369132,
  "task_id": "71c33eef-7d4e-4d36-8b1d-9a8fa6adab50",
  "id": "5508822b-922e-43d3-a044-f30396c1baf3",
  "metadata": {
    "annotation_reply": null,
    "retriever_resources": [],
    "usage": {
      "prompt_tokens": 0,
      "prompt_unit_price": "0.0",
      "prompt_price_unit": "0.0",
      "prompt_price": "0.0",
      "completion_tokens": 0,
      "completion_unit_price": "0.0",
      "completion_price_unit": "0.0",
      "completion_price": "0.0",
      "total_tokens": 0,
      "total_price": "0.0",
      "currency": "USD",
      "latency": 0
    }
  },
  "files": []
}
ğŸš¨ [BILLING-WORKFLOW_STREAM] POTENTIAL BILLING LOSS - endpoint: WORKFLOW_STREAM, user: 9dee4891-89a6-44ee-8fe8-69097846e97d, timestamp: 2025-10-02T01:38:56.115Z
âŒ [BILLING-TRACKER] Failed #1: WORKFLOW_STREAM-1759369136114-tzcsg - NO_TOKEN_DATA
ğŸš¨ [CRITICAL] Primary billing failed for WORKFLOW_STREAM, executing emergency billing!
ğŸš¨ [CRITICAL] Request context: {
  isNewConversation: false,
  hasConversationId: true,
  emergencyFallback: false,
  endpoint: 'WORKFLOW_STREAM'
}
ğŸ¯ [BILLING-TRACKER] Call #2: EMERGENCY_STREAM-1759369136115-d7h8i
ğŸ” [BILLING-EMERGENCY_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: false,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-EMERGENCY_STREAM] Found usage in metadata.usage
ğŸš¨ [BILLING-EMERGENCY_STREAM] EMERGENCY FALLBACK billing: 200 tokens
âš ï¸ [BILLING-EMERGENCY_STREAM] This billing was triggered by context management failure
ğŸ’° [COST-EMERGENCY_STREAM] Actual cost: $0.000435 = 5 points
âœ… [BILLING-EMERGENCY_STREAM] Deducted 5 points. Balance: 5337 â†’ 5332
âœ… [BILLING-TRACKER] Success #1: EMERGENCY_STREAM-1759369136115-d7h8i
ğŸ”§ [EMERGENCY] Forced billing result: {
  tokens: 200,
  points: 5,
  cost: '0.000435',
  newBalance: 5332,
  success: true,
  emergencyFallback: true
}
ğŸ”¥ [STREAM] Sending balance update to frontend: 5332
ğŸ” ensureConversationExists called with: {
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  difyConversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 7ec79db8-6395-4242-b20d-95ca9cdf9e5cï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T01:40:26.523Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '98807de5588ce7c9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 01:40:28 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=5jVHLH%2BMIffPgjy4xmxGocMcZ4rvFTtvfULY6thuDQoSadp6CCdyDRFil21MNUyUYum99hWsovvf8C5EDmht55s59EjrRm%2F2uYvi6eie4VYN3lgfy2c%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +267 tokens, $0.000702 (ç´¯è®¡: 267 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +473 tokens, $0.000982 (ç´¯è®¡: 740 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 740 tokens
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: false,
  tokensValue: 0,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #3: WORKFLOW_STREAM-1759369231447-jm1c1
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: false,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
ğŸš¨ [BILLING-WORKFLOW_STREAM] NO TOKEN USAGE DATA FOUND! This interaction will not be billed!
ğŸš¨ [BILLING-WORKFLOW_STREAM] responseData structure: {
  "event": "message_end",
  "conversation_id": "4639b04d-90e1-4f49-aedd-111f92c42189",
  "message_id": "44a744bb-46fe-4a14-89d1-f326923a1b66",
  "created_at": 1759369228,
  "task_id": "054d75e0-2367-41f4-9573-7b05cca2f2b9",
  "id": "44a744bb-46fe-4a14-89d1-f326923a1b66",
  "metadata": {
    "annotation_reply": null,
    "retriever_resources": [],
    "usage": {
      "prompt_tokens": 0,
      "prompt_unit_price": "0.0",
      "prompt_price_unit": "0.0",
      "prompt_price": "0.0",
      "completion_tokens": 0,
      "completion_unit_price": "0.0",
      "completion_price_unit": "0.0",
      "completion_price": "0.0",
      "total_tokens": 0,
      "total_price": "0.0",
      "currency": "USD",
      "latency": 0
    }
  },
  "files": []
}
ğŸš¨ [BILLING-WORKFLOW_STREAM] POTENTIAL BILLING LOSS - endpoint: WORKFLOW_STREAM, user: 9dee4891-89a6-44ee-8fe8-69097846e97d, timestamp: 2025-10-02T01:40:31.448Z
âŒ [BILLING-TRACKER] Failed #2: WORKFLOW_STREAM-1759369231447-jm1c1 - NO_TOKEN_DATA
ğŸš¨ [CRITICAL] Primary billing failed for WORKFLOW_STREAM, executing emergency billing!
ğŸš¨ [CRITICAL] Request context: {
  isNewConversation: true,
  hasConversationId: false,
  emergencyFallback: false,
  endpoint: 'WORKFLOW_STREAM'
}
ğŸ¯ [BILLING-TRACKER] Call #4: EMERGENCY_STREAM-1759369231448-iw1hi
ğŸ” [BILLING-EMERGENCY_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: false,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-EMERGENCY_STREAM] Found usage in metadata.usage
ğŸš¨ [BILLING-EMERGENCY_STREAM] EMERGENCY FALLBACK billing: 200 tokens
âš ï¸ [BILLING-EMERGENCY_STREAM] This billing was triggered by context management failure
ğŸ’° [COST-EMERGENCY_STREAM] Actual cost: $0.000435 = 5 points
âœ… [BILLING-EMERGENCY_STREAM] Deducted 5 points. Balance: 5332 â†’ 5327
âœ… [BILLING-TRACKER] Success #2: EMERGENCY_STREAM-1759369231448-iw1hi
ğŸ”§ [EMERGENCY] Forced billing result: {
  tokens: 200,
  points: 5,
  cost: '0.000435',
  newBalance: 5327,
  success: true,
  emergencyFallback: true
}
ğŸ”¥ [STREAM] Sending balance update to frontend: 5327
ğŸ” ensureConversationExists called with: {
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  difyConversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
