[dotenv@17.2.1] injecting env (19) from .env -- tip: 🔐 prevent committing .env to code: https://dotenvx.com/precommit
🚀 Starting Prome Platform server
✅ Dify API environment variables are configured
Server is running on port 8080
🔍 Performing database health check...
✅ Database health check passed - all required tables exist
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "3080adaa-7997-4962-af5d-6b71e757d573",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🔄 继续现有对话: 3080adaa-7997-4962-af5d-6b71e757d573
🔍 Looking up conversation in database: 3080adaa-7997-4962-af5d-6b71e757d573
✅ Found existing DIFY conversation: 3080adaa-7997-4962-af5d-6b71e757d573
🔄 Continuing existing conversation: 3080adaa-7997-4962-af5d-6b71e757d573
📤 [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '3080adaa-7997-4962-af5d-6b71e757d573',
  timestamp: '2025-10-02T01:38:50.528Z'
}
📊 Context check: 33 tokens, within limit
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '98807b8d4d16aad1-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 01:38:52 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=kLz6kwtmmU%2Bh83oalgXNp9fiCgOd3Ew5jf%2B278c%2B9opKWllvKzbrs8Zfb8BPM%2BBW55U2HLePfnxXzlnomUgZ%2BU74ZXxMfmrd2hE%2BcApSQK%2B533SLwA8%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +346 tokens, $0.000848 (累计: 346 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +471 tokens, $0.000978 (累计: 817 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: false
}
[Server] ✅ message_end的usage为0，使用从node_finished累加的数据: 817 tokens
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: false,
  tokensValue: 0,
  billingSource: 'NORMAL'
}
🎯 [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759369136114-tzcsg
🔍 [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: false,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
🚨 [BILLING-WORKFLOW_STREAM] NO TOKEN USAGE DATA FOUND! This interaction will not be billed!
🚨 [BILLING-WORKFLOW_STREAM] responseData structure: {
  "event": "message_end",
  "conversation_id": "3080adaa-7997-4962-af5d-6b71e757d573",
  "message_id": "5508822b-922e-43d3-a044-f30396c1baf3",
  "created_at": 1759369132,
  "task_id": "71c33eef-7d4e-4d36-8b1d-9a8fa6adab50",
  "id": "5508822b-922e-43d3-a044-f30396c1baf3",
  "metadata": {
    "annotation_reply": null,
    "retriever_resources": [],
    "usage": {
      "prompt_tokens": 0,
      "prompt_unit_price": "0.0",
      "prompt_price_unit": "0.0",
      "prompt_price": "0.0",
      "completion_tokens": 0,
      "completion_unit_price": "0.0",
      "completion_price_unit": "0.0",
      "completion_price": "0.0",
      "total_tokens": 0,
      "total_price": "0.0",
      "currency": "USD",
      "latency": 0
    }
  },
  "files": []
}
🚨 [BILLING-WORKFLOW_STREAM] POTENTIAL BILLING LOSS - endpoint: WORKFLOW_STREAM, user: 9dee4891-89a6-44ee-8fe8-69097846e97d, timestamp: 2025-10-02T01:38:56.115Z
❌ [BILLING-TRACKER] Failed #1: WORKFLOW_STREAM-1759369136114-tzcsg - NO_TOKEN_DATA
🚨 [CRITICAL] Primary billing failed for WORKFLOW_STREAM, executing emergency billing!
🚨 [CRITICAL] Request context: {
  isNewConversation: false,
  hasConversationId: true,
  emergencyFallback: false,
  endpoint: 'WORKFLOW_STREAM'
}
🎯 [BILLING-TRACKER] Call #2: EMERGENCY_STREAM-1759369136115-d7h8i
🔍 [BILLING-EMERGENCY_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: false,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
✅ [BILLING-EMERGENCY_STREAM] Found usage in metadata.usage
🚨 [BILLING-EMERGENCY_STREAM] EMERGENCY FALLBACK billing: 200 tokens
⚠️ [BILLING-EMERGENCY_STREAM] This billing was triggered by context management failure
💰 [COST-EMERGENCY_STREAM] Actual cost: $0.000435 = 5 points
✅ [BILLING-EMERGENCY_STREAM] Deducted 5 points. Balance: 5337 → 5332
✅ [BILLING-TRACKER] Success #1: EMERGENCY_STREAM-1759369136115-d7h8i
🔧 [EMERGENCY] Forced billing result: {
  tokens: 200,
  points: 5,
  cost: '0.000435',
  newBalance: 5332,
  success: true,
  emergencyFallback: true
}
🔥 [STREAM] Sending balance update to frontend: 5332
🔍 ensureConversationExists called with: {
  conversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  difyConversationId: '3080adaa-7997-4962-af5d-6b71e757d573',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Messages saved successfully
✅ Saved streaming conversation to database
🔍 INCOMING REQUEST: POST /api/dify
🗣️ GENERIC /api/dify ENDPOINT CALLED
📊 Streaming mode: body=true, query=false, final=true
🔍 Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
🆕 前端要求新对话 - 生成全新conversation ID: 7ec79db8-6395-4242-b20d-95ca9cdf9e5c，不查找数据库
🆕 Starting new conversation - letting DIFY initialize conversation variables
📤 [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T01:40:26.523Z'
}
📊 New conversation, no context management needed
📋 Preparing request for DIFY chatflow processing...
[Server Generic] 🔍 Dify API 响应头: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '98807de5588ce7c9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 01:40:28 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=5jVHLH%2BMIffPgjy4xmxGocMcZ4rvFTtvfULY6thuDQoSadp6CCdyDRFil21MNUyUYum99hWsovvf8C5EDmht55s59EjrRm%2F2uYvi6eie4VYN3lgfy2c%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] 响应头元数据检查: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
🔄 Handling streaming response from Dify API
📤 Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +267 tokens, $0.000702 (累计: 267 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] 💰 从node_finished提取token: +473 tokens, $0.000982 (累计: 740 tokens)
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
📤 Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: false
}
[Server] ✅ message_end的usage为0，使用从node_finished累加的数据: 740 tokens
📤 Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  hasUsage: true
}
[Server] 📡 Stream读取完成 - checking for pending usage data
[Server] 📊 结合响应头和响应体数据准备发送混合token使用信息
[Server] ⚠️ 仅使用响应体usage信息
[Server] ✅ 混合token使用信息已发送到前端
🔍 [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: false,
  tokensValue: 0,
  billingSource: 'NORMAL'
}
🎯 [BILLING-TRACKER] Call #3: WORKFLOW_STREAM-1759369231447-jm1c1
🔍 [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: false,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
🚨 [BILLING-WORKFLOW_STREAM] NO TOKEN USAGE DATA FOUND! This interaction will not be billed!
🚨 [BILLING-WORKFLOW_STREAM] responseData structure: {
  "event": "message_end",
  "conversation_id": "4639b04d-90e1-4f49-aedd-111f92c42189",
  "message_id": "44a744bb-46fe-4a14-89d1-f326923a1b66",
  "created_at": 1759369228,
  "task_id": "054d75e0-2367-41f4-9573-7b05cca2f2b9",
  "id": "44a744bb-46fe-4a14-89d1-f326923a1b66",
  "metadata": {
    "annotation_reply": null,
    "retriever_resources": [],
    "usage": {
      "prompt_tokens": 0,
      "prompt_unit_price": "0.0",
      "prompt_price_unit": "0.0",
      "prompt_price": "0.0",
      "completion_tokens": 0,
      "completion_unit_price": "0.0",
      "completion_price_unit": "0.0",
      "completion_price": "0.0",
      "total_tokens": 0,
      "total_price": "0.0",
      "currency": "USD",
      "latency": 0
    }
  },
  "files": []
}
🚨 [BILLING-WORKFLOW_STREAM] POTENTIAL BILLING LOSS - endpoint: WORKFLOW_STREAM, user: 9dee4891-89a6-44ee-8fe8-69097846e97d, timestamp: 2025-10-02T01:40:31.448Z
❌ [BILLING-TRACKER] Failed #2: WORKFLOW_STREAM-1759369231447-jm1c1 - NO_TOKEN_DATA
🚨 [CRITICAL] Primary billing failed for WORKFLOW_STREAM, executing emergency billing!
🚨 [CRITICAL] Request context: {
  isNewConversation: true,
  hasConversationId: false,
  emergencyFallback: false,
  endpoint: 'WORKFLOW_STREAM'
}
🎯 [BILLING-TRACKER] Call #4: EMERGENCY_STREAM-1759369231448-iw1hi
🔍 [BILLING-EMERGENCY_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: false,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
✅ [BILLING-EMERGENCY_STREAM] Found usage in metadata.usage
🚨 [BILLING-EMERGENCY_STREAM] EMERGENCY FALLBACK billing: 200 tokens
⚠️ [BILLING-EMERGENCY_STREAM] This billing was triggered by context management failure
💰 [COST-EMERGENCY_STREAM] Actual cost: $0.000435 = 5 points
✅ [BILLING-EMERGENCY_STREAM] Deducted 5 points. Balance: 5332 → 5327
✅ [BILLING-TRACKER] Success #2: EMERGENCY_STREAM-1759369231448-iw1hi
🔧 [EMERGENCY] Forced billing result: {
  tokens: 200,
  points: 5,
  cost: '0.000435',
  newBalance: 5327,
  success: true,
  emergencyFallback: true
}
🔥 [STREAM] Sending balance update to frontend: 5327
🔍 ensureConversationExists called with: {
  conversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  difyConversationId: '4639b04d-90e1-4f49-aedd-111f92c42189',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
✅ Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
✅ Created new conversation record
✅ Messages saved successfully
✅ Saved streaming conversation to database
