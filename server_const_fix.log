[dotenv@17.2.1] injecting env (19) from .env -- tip: ğŸ” prevent committing .env to code: https://dotenvx.com/precommit
ğŸš€ Starting Prome Platform server
âœ… Dify API environment variables are configured
Server is running on port 8080
ğŸ” Performing database health check...
âœ… Database health check passed - all required tables exist
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "62a9773f-0ee8-407a-853d-0cdbf4b3c295",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 62a9773f-0ee8-407a-853d-0cdbf4b3c295
ğŸ” Looking up conversation in database: 62a9773f-0ee8-407a-853d-0cdbf4b3c295
âœ… Found existing DIFY conversation: 62a9773f-0ee8-407a-853d-0cdbf4b3c295
ğŸ”„ Continuing existing conversation: 62a9773f-0ee8-407a-853d-0cdbf4b3c295
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  timestamp: '2025-10-02T02:26:11.173Z'
}
ğŸ“Š Context check: 16 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880c0e8ffefaacb-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:26:12 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=egkkcHgGW2455ZlLzc66F9NS7gnd5UJhMve8OmXhNVtXRYj9yjWHfbuX2dfJ6yF4xZWedccc9t7r%2BM3jGG7ORn6K8wwk1R341kqSyBaPBwlFT%2BkicXQ%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +291 tokens, $0.000708 (ç´¯è®¡: 291 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +466 tokens, $0.000968 (ç´¯è®¡: 757 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 757 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 757 tokens, $0.001676
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 757,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #1: WORKFLOW_STREAM-1759371978163-hsrgc
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 757 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001676 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5273 â†’ 5252
âœ… [BILLING-TRACKER] Success #1: WORKFLOW_STREAM-1759371978163-hsrgc
ğŸ”¥ [STREAM] Sending balance update to frontend: 5252
ğŸ” ensureConversationExists called with: {
  conversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  difyConversationId: '62a9773f-0ee8-407a-853d-0cdbf4b3c295',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ç†Š",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: af74c18b-27d1-49ed-a78c-f778842c39e3ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ç†Š...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:27:50.981Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880c357f89aa7f9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:27:52 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=JGI8qCORGCLLODZun9hMM2kjtBtPvnAKaYplV%2BohQGyYdWIHUsTZ0gTZjJ0P%2B2ER190D0A%2FuGM1VtFY4G2IVkOiwwEdVQt8bnc1Uk%2FYPanm%2FEMsfKWY%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +270 tokens, $0.000726 (ç´¯è®¡: 270 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +476 tokens, $0.000988 (ç´¯è®¡: 746 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 746 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 746 tokens, $0.0017139999999999998
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 746,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #2: WORKFLOW_STREAM-1759372075835-oqfse
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 746 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001714 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 22 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 22 points. Balance: 5231 â†’ 5209
âœ… [BILLING-TRACKER] Success #2: WORKFLOW_STREAM-1759372075835-oqfse
ğŸ”¥ [STREAM] Sending balance update to frontend: 5209
ğŸ” ensureConversationExists called with: {
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  difyConversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "è¿˜",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "de80f7f4-96dd-40c5-a1bf-7f4cd142d4af",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: de80f7f4-96dd-40c5-a1bf-7f4cd142d4af
ğŸ” Looking up conversation in database: de80f7f4-96dd-40c5-a1bf-7f4cd142d4af
âœ… Found existing DIFY conversation: de80f7f4-96dd-40c5-a1bf-7f4cd142d4af
ğŸ”„ Continuing existing conversation: de80f7f4-96dd-40c5-a1bf-7f4cd142d4af
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'è¿˜...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  timestamp: '2025-10-02T02:28:22.072Z'
}
ğŸ“Š Context check: 18 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880c4196e735f22-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:28:23 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=eiypROl2vX10wO%2Fep7F5h%2B5sX2dr1aLn2FRN2AC7lcmTRqSEHbxcLPqqNeWtNFoD1BTKCDuIjGwhtDS51bWfMO%2FJbtEWiun2CAfEfnpeCDRZExZs"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +318 tokens, $0.00087 (ç´¯è®¡: 318 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +484 tokens, $0.001004 (ç´¯è®¡: 802 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 802 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 802 tokens, $0.0018739999999999998
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 802,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #3: WORKFLOW_STREAM-1759372107129-gn66g
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 802 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001874 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 24 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 24 points. Balance: 5209 â†’ 5185
âœ… [BILLING-TRACKER] Success #3: WORKFLOW_STREAM-1759372107129-gn66g
ğŸ”¥ [STREAM] Sending balance update to frontend: 5185
ğŸ” ensureConversationExists called with: {
  conversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  difyConversationId: 'de80f7f4-96dd-40c5-a1bf-7f4cd142d4af',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "hi",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 4767b01e-e492-46fa-a28b-efa1a97ff474ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'hi...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:28:45.191Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880c4abd8b5a80d-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:28:46 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=KCHW6Op6zy7pVigZ0bxfU6nCe%2F1X9NqgQJ6Qw09cQpEghUwjHRg8uqGATeAmetAi50LlWcXY3LRLWoKIIczeLJ7xiJIZl8ko9l0BrNLTG6xP1iFaQpc%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +262 tokens, $0.000662 (ç´¯è®¡: 262 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +468 tokens, $0.000972 (ç´¯è®¡: 730 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 730 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 730 tokens, $0.001634
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 730,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #4: WORKFLOW_STREAM-1759372130344-nl31e
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 730 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001634 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5162 â†’ 5141
âœ… [BILLING-TRACKER] Success #4: WORKFLOW_STREAM-1759372130344-nl31e
ğŸ”¥ [STREAM] Sending balance update to frontend: 5141
ğŸ” ensureConversationExists called with: {
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  difyConversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "78a23d33-9fc6-4de0-8a1a-212417bb15b7",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 78a23d33-9fc6-4de0-8a1a-212417bb15b7
ğŸ” Looking up conversation in database: 78a23d33-9fc6-4de0-8a1a-212417bb15b7
âœ… Found existing DIFY conversation: 78a23d33-9fc6-4de0-8a1a-212417bb15b7
ğŸ”„ Continuing existing conversation: 78a23d33-9fc6-4de0-8a1a-212417bb15b7
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  timestamp: '2025-10-02T02:36:53.819Z'
}
ğŸ“Š Context check: 18 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d09a0ef2e7c6-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:36:55 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=7rMGQpybkJSyBEduvLHGzD7dz7mNjQu4stD%2BsOmWFIAa%2BuL6xvUjUzaAq%2BxtZtk3gJaavd8DXHf%2FZ4uTNVZME4BUrWZr3ixJLvmFrqf07WkJ%2FEDEtX8%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +294 tokens, $0.000726 (ç´¯è®¡: 294 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +468 tokens, $0.000972 (ç´¯è®¡: 762 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 762 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 762 tokens, $0.0016979999999999999
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 762,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #5: WORKFLOW_STREAM-1759372618904-fiu3w
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 762 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001698 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 22 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 22 points. Balance: 5141 â†’ 5119
âœ… [BILLING-TRACKER] Success #5: WORKFLOW_STREAM-1759372618904-fiu3w
ğŸ”¥ [STREAM] Sending balance update to frontend: 5119
ğŸ” ensureConversationExists called with: {
  conversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  difyConversationId: '78a23d33-9fc6-4de0-8a1a-212417bb15b7',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å“ˆ",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 6cd6ac1b-f429-467e-ba85-e3ca85479d93ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å“ˆ...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:37:31.892Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d186ed165739-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:37:33 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=um9VZQ35Pxt5%2FPvYxOnJI7ROn%2BmiXcu%2BynClEO6aJR3%2Bf48TzgCYtBs7ModAYPR%2FCvlG5aF52ZzqAfbPPdewMq1MFl71%2FRBSsFpq4vVouqiPAPFhhJw%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +263 tokens, $0.000664 (ç´¯è®¡: 263 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +468 tokens, $0.000972 (ç´¯è®¡: 731 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 731 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 731 tokens, $0.0016359999999999999
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 731,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #6: WORKFLOW_STREAM-1759372656059-fctp3
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 731 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001636 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5119 â†’ 5098
âœ… [BILLING-TRACKER] Success #6: WORKFLOW_STREAM-1759372656059-fctp3
ğŸ”¥ [STREAM] Sending balance update to frontend: 5098
ğŸ” ensureConversationExists called with: {
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  difyConversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "93900d9a-ec7b-475f-8fa6-8c75adc49cfb",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 93900d9a-ec7b-475f-8fa6-8c75adc49cfb
ğŸ” Looking up conversation in database: 93900d9a-ec7b-475f-8fa6-8c75adc49cfb
âœ… Found existing DIFY conversation: 93900d9a-ec7b-475f-8fa6-8c75adc49cfb
ğŸ”„ Continuing existing conversation: 93900d9a-ec7b-475f-8fa6-8c75adc49cfb
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  timestamp: '2025-10-02T02:37:49.997Z'
}
ğŸ“Š Context check: 20 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d1f95d6097c5-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:37:51 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=aU4DEn%2BY%2BVI6I4F7XItBtlGYreVYQrG%2FvEbcaT%2FbqqrNxHEKa8t8bidRJbXfE72IS1AOBfROKvCdVJoxsBoOqFpjKJJDmw4nzEkQJx5NX2MnFtRbJ4M%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +295 tokens, $0.000728 (ç´¯è®¡: 295 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +468 tokens, $0.000972 (ç´¯è®¡: 763 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 763 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 763 tokens, $0.0017000000000000001
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 763,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #7: WORKFLOW_STREAM-1759372673904-vtn6h
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 763 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001700 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 22 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 22 points. Balance: 5078 â†’ 5056
âœ… [BILLING-TRACKER] Success #7: WORKFLOW_STREAM-1759372673904-vtn6h
ğŸ”¥ [STREAM] Sending balance update to frontend: 5056
ğŸ” ensureConversationExists called with: {
  conversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  difyConversationId: '93900d9a-ec7b-475f-8fa6-8c75adc49cfb',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: d6554c8f-c29c-4214-b6c4-13ec03e0f702ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:38:05.021Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d2552f826c65-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:38:06 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=lSJQLOoF1ZIqpOY7Q4xam3Nfl0ciib7VRo4z93tdOQi1H9ZPKQweTEOK4FVHkotwqCE6FC1vxKRY%2BJqTbP6ZG0ZebAPByRthzzTJO6wuDXRFMgQQmQQ%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +263 tokens, $0.00067 (ç´¯è®¡: 263 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +469 tokens, $0.000974 (ç´¯è®¡: 732 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 732 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 732 tokens, $0.001644
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 732,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #8: WORKFLOW_STREAM-1759372689173-qzqhy
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 732 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001644 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 5035 â†’ 5014
âœ… [BILLING-TRACKER] Success #8: WORKFLOW_STREAM-1759372689173-qzqhy
ğŸ”¥ [STREAM] Sending balance update to frontend: 5014
ğŸ” ensureConversationExists called with: {
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  difyConversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ” Looking up conversation in database: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
âœ… Found existing DIFY conversation: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ”„ Continuing existing conversation: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  timestamp: '2025-10-02T02:39:39.315Z'
}
ğŸ“Š Context check: 20 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d4a23fc3a977-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:39:40 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=JjCmPE94So0rYrjg449sqGRna%2FAVfL2OnH9BWb8cuJl11kRYBgYsJ99%2BjcW070cuhUflpj4cEfCMesou4KIoL6F9Z%2Fyo775Riwq9uVCcpvxHiu%2BUdMU%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +297 tokens, $0.000744 (ç´¯è®¡: 297 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +470 tokens, $0.000976 (ç´¯è®¡: 767 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 767 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 767 tokens, $0.00172
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 767,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #9: WORKFLOW_STREAM-1759372783580-8bly3
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 767 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001720 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 22 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 22 points. Balance: 5014 â†’ 4992
âœ… [BILLING-TRACKER] Success #9: WORKFLOW_STREAM-1759372783580-8bly3
ğŸ”¥ [STREAM] Sending balance update to frontend: 4992
ğŸ” ensureConversationExists called with: {
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  difyConversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ” Looking up conversation in database: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
âœ… Found existing DIFY conversation: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ”„ Continuing existing conversation: 8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  timestamp: '2025-10-02T02:42:06.207Z'
}
ğŸ“Š Context check: 37 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d838a89ee7ec-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:42:07 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=uJgwJr8r3EJ3YbVzwDAmcekBV2LeMDzGJiRLydTw0eRw73C6QnW8xlzYA4m%2BY6xuNHD%2FrMec9z%2Bghs7Man4odg8NJXKDmNny7EO146LUP8OealcowiA%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +332 tokens, $0.00082 (ç´¯è®¡: 332 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +471 tokens, $0.000978 (ç´¯è®¡: 803 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 803 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 803 tokens, $0.001798
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 803,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #10: WORKFLOW_STREAM-1759372931849-v9a1s
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 803 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001798 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 23 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 23 points. Balance: 4992 â†’ 4969
âœ… [BILLING-TRACKER] Success #10: WORKFLOW_STREAM-1759372931849-v9a1s
ğŸ”¥ [STREAM] Sending balance update to frontend: 4969
ğŸ” ensureConversationExists called with: {
  conversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  difyConversationId: '8c42ee0e-a1d8-4401-8221-0a3e6e9ab04d',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å¥½",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 01008166-5b9a-47b8-b949-5669661c50e2ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å¥½...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:42:20.514Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d8939ecdaae9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:42:22 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=%2BOffpNa8U%2FTADUIV6sbbYFGRYg7OZ3CVJ6eFnhk4jDhgcO1pCvvhXVJ4FzCjvo6WlQWEoCbkTEJ7mZAgRLqlHnUjiaLw2aZxjoVjvjTc2dltTYhV3wI%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +260 tokens, $0.000646 (ç´¯è®¡: 260 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +466 tokens, $0.000968 (ç´¯è®¡: 726 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 726 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 726 tokens, $0.001614
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 726,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #11: WORKFLOW_STREAM-1759372944437-u1dtf
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 726 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001614 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 4947 â†’ 4926
âœ… [BILLING-TRACKER] Success #11: WORKFLOW_STREAM-1759372944437-u1dtf
ğŸ”¥ [STREAM] Sending balance update to frontend: 4926
ğŸ” ensureConversationExists called with: {
  conversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  difyConversationId: '923196c8-aa53-495c-b3c5-07835dca484e',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ å“ˆã€",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 72fb534e-05e9-4d04-9654-51ef7ded1a83ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ å“ˆã€...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:42:30.293Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d8cf7c0b5e4f-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:42:31 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=9sKlx8ltuRLBEzuC0kQgA84loqfCgKLaISG1py14txcoyBAMt%2FILEIw%2BFKMOLA8ocI2EbigkMoKHQ1kw2fUvN1karJi0bUBwGg8xZhAoXGNVa%2F1%2FkYk%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +265 tokens, $0.000674 (ç´¯è®¡: 265 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +464 tokens, $0.000934 (ç´¯è®¡: 729 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 729 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 729 tokens, $0.001608
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 729,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #12: WORKFLOW_STREAM-1759372954391-8f8oc
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 729 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001608 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 4906 â†’ 4885
âœ… [BILLING-TRACKER] Success #12: WORKFLOW_STREAM-1759372954391-8f8oc
ğŸ”¥ [STREAM] Sending balance update to frontend: 4885
ğŸ” ensureConversationExists called with: {
  conversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  difyConversationId: '1a2826c0-3603-47dd-8360-2ef00cabf849',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä½ ",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: 4b687cab-3dd6-41bd-8e93-ccbe5417d386ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä½ ...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:42:40.314Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d9100eabaae9-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:42:42 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=Qh0dIAO5k7zeRW9TJLJ67Sy8An3CaGNRxfXeg%2Fahvtw0LvBWlzw01t0kq4eospHcZNK2hxlc5Q3pRFYvxxTZUvqUuv5r48ykTHQ%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +260 tokens, $0.000646 (ç´¯è®¡: 260 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +466 tokens, $0.000968 (ç´¯è®¡: 726 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 726 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 726 tokens, $0.001614
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 726,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #13: WORKFLOW_STREAM-1759372964364-u60n5
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 726 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001614 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 4865 â†’ 4844
âœ… [BILLING-TRACKER] Success #13: WORKFLOW_STREAM-1759372964364-u60n5
ğŸ”¥ [STREAM] Sending balance update to frontend: 4844
ğŸ” ensureConversationExists called with: {
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  difyConversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä¸å¯è§",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": "4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe",
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ”„ ç»§ç»­ç°æœ‰å¯¹è¯: 4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe
ğŸ” Looking up conversation in database: 4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe
âœ… Found existing DIFY conversation: 4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe
ğŸ”„ Continuing existing conversation: 4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä¸å¯è§...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  timestamp: '2025-10-02T02:42:51.362Z'
}
ğŸ“Š Context check: 20 tokens, within limit
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d9528f3ee7e4-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:42:52 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=kqtHCy3NEJUIbrMLwFlCs3TuXS0Dt6N2iOdswg%2FmboCuxytdRL12zvqtOtSq6wV%2BHZhoSlzxaXsTSTN40KweNCN6Lx0sUStVz6lOF6ffjhP77RsinZs%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +291 tokens, $0.000708 (ç´¯è®¡: 291 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +466 tokens, $0.000968 (ç´¯è®¡: 757 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 757 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 757 tokens, $0.001676
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 757,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #14: WORKFLOW_STREAM-1759372974408-r5bip
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 757 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001676 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 21 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 21 points. Balance: 4844 â†’ 4823
âœ… [BILLING-TRACKER] Success #14: WORKFLOW_STREAM-1759372974408-r5bip
ğŸ”¥ [STREAM] Sending balance update to frontend: 4823
ğŸ” ensureConversationExists called with: {
  conversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  difyConversationId: '4d4a95dc-f14a-4fa6-b6e4-e0fcdfd969fe',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
ğŸ” INCOMING REQUEST: POST /api/dify
ğŸ—£ï¸ GENERIC /api/dify ENDPOINT CALLED
ğŸ“Š Streaming mode: body=true, query=false, final=true
ğŸ” Full request body: {
  "query": "ä¸å¥åº·â€˜",
  "user": "9dee4891-89a6-44ee-8fe8-69097846e97d",
  "conversation_id": null,
  "response_mode": "streaming",
  "stream": true,
  "auto_generate_name": true,
  "inputs": {}
}
ğŸ†• å‰ç«¯è¦æ±‚æ–°å¯¹è¯ - ç”Ÿæˆå…¨æ–°conversation ID: d53bc190-2b30-4c42-acab-97a7af615a87ï¼Œä¸æŸ¥æ‰¾æ•°æ®åº“
ğŸ†• Starting new conversation - letting DIFY initialize conversation variables
ğŸ“¤ [DIFY API] Sending request to chat-messages: {
  query: 'ä¸å¥åº·â€˜...',
  inputs: {},
  response_mode: 'streaming',
  user: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  conversation_id: 'NEW_CONVERSATION',
  timestamp: '2025-10-02T02:43:00.396Z'
}
ğŸ“Š New conversation, no context management needed
ğŸ“‹ Preparing request for DIFY chatflow processing...
[Server Generic] ğŸ” Dify API å“åº”å¤´: {
  'access-control-allow-origin': '*',
  'cf-cache-status': 'DYNAMIC',
  'cf-ray': '9880d98c6bfee7ed-SYD',
  connection: 'keep-alive',
  'content-type': 'text/event-stream; charset=utf-8',
  date: 'Thu, 02 Oct 2025 02:43:01 GMT',
  nel: '{"report_to":"cf-nel","success_fraction":0.0,"max_age":604800}',
  'report-to': '{"group":"cf-nel","max_age":604800,"endpoints":[{"url":"https://a.nel.cloudflare.com/report/v4?s=7XWMIE%2F9EypgdnZnKlxeyDv%2BGKm2UjXcS3DB%2F2YO%2FHV%2BkcjQO5qFIyPp74BBl%2F3vzCxx3O4OYFAut54Xs1olmpcjBbNSLGdyvlX9sToM0Wm8b5F25QE%3D"}]}',
  server: 'cloudflare',
  'strict-transport-security': 'max-age=31536000; includeSubDomains',
  'transfer-encoding': 'chunked',
  'x-content-type-options': 'nosniff',
  'x-env': 'PRODUCTION',
  'x-frame-options': 'DENY',
  'x-version': '1.9.1'
}
[Server Generic] å“åº”å¤´å…ƒæ•°æ®æ£€æŸ¥: {
  'x-usage-input-tokens': null,
  'x-usage-output-tokens': null,
  'x-dify-model': null,
  'x-dify-request-id': null,
  hasTokenStats: false,
  hasModelInfo: false
}
ğŸ”„ Handling streaming response from Dify API
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: true,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'message',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +276 tokens, $0.000762 (ç´¯è®¡: 276 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
[Server] ğŸ’° ä»node_finishedæå–token: +480 tokens, $0.000996 (ç´¯è®¡: 756 tokens)
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_started',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'node_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
ğŸ“¤ Forwarded streaming data: {
  event: 'workflow_finished',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: false
}
[Server] âœ… message_endçš„usageä¸º0ï¼Œä½¿ç”¨ä»node_finishedç´¯åŠ çš„æ•°æ®: 756 tokens
[Server] âœ… å·²å°†ç´¯åŠ çš„usageè¦†ç›–åˆ°message_endäº‹ä»¶ä¸­ï¼Œå‡†å¤‡è½¬å‘ç»™å‰ç«¯
ğŸ“¤ Forwarded streaming data: {
  event: 'message_end',
  hasAnswer: false,
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  hasUsage: true
}
[Server] ğŸ“¡ Streamè¯»å–å®Œæˆ - checking for pending usage data
[Server] ğŸ“Š ç»“åˆå“åº”å¤´å’Œå“åº”ä½“æ•°æ®å‡†å¤‡å‘é€æ··åˆtokenä½¿ç”¨ä¿¡æ¯
[Server] âš ï¸ ä»…ä½¿ç”¨å“åº”ä½“usageä¿¡æ¯
[Server] âœ… æ··åˆtokenä½¿ç”¨ä¿¡æ¯å·²å‘é€åˆ°å‰ç«¯
âœ… [BILLING-FIX] ç”¨ä»node_finishedç´¯åŠ çš„usageè¦†ç›–finalData: 756 tokens, $0.001758
ğŸ” [DEBUG] finalData structure for billing: {
  hasFinalData: true,
  hasMetadata: true,
  hasUsage: true,
  hasTokens: true,
  tokensValue: 756,
  billingSource: 'NORMAL'
}
ğŸ¯ [BILLING-TRACKER] Call #15: WORKFLOW_STREAM-1759372985489-sihx9
ğŸ” [BILLING-WORKFLOW_STREAM] Checking data sources: {
  hasResponseData: true,
  hasHeaderMetadata: true,
  hasMetadata: true,
  hasUsage: true,
  hasTotalTokens: true,
  hasUsageField: false,
  hasHeaderUsage: false,
  headerModel: 'unknown'
}
âœ… [BILLING-WORKFLOW_STREAM] Found usage in metadata.usage
ğŸ’° [BILLING-WORKFLOW_STREAM] Multi-node LLM: 756 tokens
ğŸ’° [COST-WORKFLOW_STREAM] Difyæˆæœ¬: $0.001758 â†’ +25%åˆ©æ¶¦ â†’ Ã—10000æ±‡ç‡ = 22 ç§¯åˆ†
âœ… [BILLING-WORKFLOW_STREAM] Deducted 22 points. Balance: 4802 â†’ 4780
âœ… [BILLING-TRACKER] Success #15: WORKFLOW_STREAM-1759372985489-sihx9
ğŸ”¥ [STREAM] Sending balance update to frontend: 4780
ğŸ” ensureConversationExists called with: {
  conversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  difyConversationId: '953f2159-b4ee-4cb0-9440-d8532678839a',
  userId: '9dee4891-89a6-44ee-8fe8-69097846e97d',
  hasSupabase: true
}
âœ… Verified user exists in database: 9dee4891-89a6-44ee-8fe8-69097846e97d
âœ… Created new conversation record
âœ… Messages saved successfully
âœ… Saved streaming conversation to database
