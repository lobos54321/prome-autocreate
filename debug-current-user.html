<!DOCTYPE html>
<html>
<head>
  <title>用户状态诊断</title>
  <style>
    body { font-family: monospace; padding: 20px; background: #f5f5f5; }
    .section { background: white; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .label { font-weight: bold; color: #333; }
    .value { color: #0066cc; }
    .error { color: #cc0000; }
    .success { color: #00cc00; }
    pre { background: #f0f0f0; padding: 10px; overflow: auto; }
  </style>
</head>
<body>
  <h1>🔍 用户状态诊断工具</h1>
  
  <div class="section">
    <h2>LocalStorage 数据</h2>
    <div id="localStorage-data"></div>
  </div>
  
  <div class="section">
    <h2>SessionStorage 数据</h2>
    <div id="sessionStorage-data"></div>
  </div>
  
  <div class="section">
    <h2>当前用户信息</h2>
    <div id="current-user"></div>
  </div>
  
  <div class="section">
    <h2>Dify相关数据</h2>
    <div id="dify-data"></div>
  </div>

  <script>
    // 显示localStorage数据
    const localStorageDiv = document.getElementById('localStorage-data');
    const localData = {};
    for (let i = 0; i < localStorage.length; i++) {
      const key = localStorage.key(i);
      localData[key] = localStorage.getItem(key);
    }
    localStorageDiv.innerHTML = '<pre>' + JSON.stringify(localData, null, 2) + '</pre>';
    
    // 显示sessionStorage数据
    const sessionStorageDiv = document.getElementById('sessionStorage-data');
    const sessionData = {};
    for (let i = 0; i < sessionStorage.length; i++) {
      const key = sessionStorage.key(i);
      sessionData[key] = sessionStorage.getItem(key);
    }
    sessionStorageDiv.innerHTML = '<pre>' + JSON.stringify(sessionData, null, 2) + '</pre>';
    
    // 显示当前用户
    const currentUserDiv = document.getElementById('current-user');
    const currentUser = localStorage.getItem('currentUser');
    if (currentUser) {
      try {
        const user = JSON.parse(currentUser);
        currentUserDiv.innerHTML = `
          <p><span class="label">用户ID:</span> <span class="value">${user.id || '未知'}</span></p>
          <p><span class="label">Email:</span> <span class="value">${user.email || '未知'}</span></p>
          <p><span class="label">余额:</span> <span class="value">${user.balance || 0} 积分</span></p>
          <p><span class="label">名字:</span> <span class="value">${user.name || '未设置'}</span></p>
          <pre>${JSON.stringify(user, null, 2)}</pre>
        `;
      } catch (e) {
        currentUserDiv.innerHTML = '<p class="error">解析用户数据失败: ' + e.message + '</p>';
      }
    } else {
      currentUserDiv.innerHTML = '<p class="error">⚠️ 未找到currentUser数据（可能未登录）</p>';
    }
    
    // 显示Dify数据
    const difyDataDiv = document.getElementById('dify-data');
    const difyUserId = localStorage.getItem('dify_user_id');
    const difyConversationId = localStorage.getItem('dify_conversation_id');
    const difyWorkflowState = localStorage.getItem('dify_workflow_state');
    
    difyDataDiv.innerHTML = `
      <p><span class="label">Dify User ID:</span> <span class="value">${difyUserId || '未设置'}</span></p>
      <p><span class="label">Dify Conversation ID:</span> <span class="value">${difyConversationId || '未设置'}</span></p>
      <p><span class="label">Workflow State:</span> <span class="value">${difyWorkflowState || '未设置'}</span></p>
    `;
    
    // 添加诊断建议
    const diagnosis = document.createElement('div');
    diagnosis.className = 'section';
    diagnosis.innerHTML = '<h2>🔍 诊断建议</h2><div id="diagnosis-content"></div>';
    document.body.appendChild(diagnosis);
    
    const diagnosisContent = document.getElementById('diagnosis-content');
    let suggestions = [];
    
    if (!currentUser) {
      suggestions.push('❌ <strong>问题：未登录</strong> - 请先登录账户');
    } else {
      try {
        const user = JSON.parse(currentUser);
        if (user.balance === 100) {
          suggestions.push('⚠️ <strong>余额显示100</strong> - 可能是初始值或缓存数据，请刷新页面');
        }
        if (!user.id || !user.id.match(/^[0-9a-f]{8}-[0-9a-f]{4}-[1-5][0-9a-f]{3}-[89ab][0-9a-f]{3}-[0-9a-f]{12}$/i)) {
          suggestions.push('❌ <strong>用户ID无效</strong> - 不是有效的UUID格式');
        }
      } catch (e) {}
    }
    
    if (!difyUserId || difyUserId.startsWith('fresh-user-')) {
      suggestions.push('⚠️ <strong>使用临时用户ID</strong> - 积分不会从数据库扣除');
    }
    
    if (suggestions.length === 0) {
      suggestions.push('✅ <strong>看起来正常</strong> - 但如果积分没有扣除，请联系管理员');
    }
    
    diagnosisContent.innerHTML = suggestions.join('<br>');
  </script>
</body>
</html>
